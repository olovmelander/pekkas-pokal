<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Pekkas Pokal - √Örlig t√§vling f√∂r v√§nner med omfattande statistik och datahantering">
    <meta name="keywords" content="t√§vling, pokal, statistik, v√§nner, competition">
    <meta name="author" content="Pekka's Competition Team">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Pekkas Pokal">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÜ</text></svg>">
    
    <title>Pekkas Pokal - √Örlig T√§vling</title>
    
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
          /* Colors */
          --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
          --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          --warning-gradient: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
          --danger-gradient: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
          
          --primary-color: #667eea;
          --secondary-color: #764ba2;
          --accent-color: #f093fb;
          --success-color: #4CAF50;
          --warning-color: #ff9f43;
          --danger-color: #ff4757;
          
          /* Light Theme */
          --bg-primary: #ffffff;
          --bg-secondary: #f8fafc;
          --bg-tertiary: #e2e8f0;
          --text-primary: #1a202c;
          --text-secondary: #4a5568;
          --text-muted: #718096;
          --border-color: #e2e8f0;
          --shadow-light: 0 1px 3px rgba(0,0,0,0.1);
          --shadow-medium: 0 4px 6px rgba(0,0,0,0.1);
          --shadow-heavy: 0 10px 15px rgba(0,0,0,0.1);
          
          /* Typography */
          --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          --font-size-xs: 0.75rem;
          --font-size-sm: 0.875rem;
          --font-size-base: 1rem;
          --font-size-lg: 1.125rem;
          --font-size-xl: 1.25rem;
          --font-size-2xl: 1.5rem;
          --font-size-3xl: 1.875rem;
          --font-size-4xl: 2.25rem;
          
          /* Spacing */
          --spacing-xs: 0.25rem;
          --spacing-sm: 0.5rem;
          --spacing-md: 1rem;
          --spacing-lg: 1.5rem;
          --spacing-xl: 2rem;
          --spacing-2xl: 3rem;
          
          /* Border Radius */
          --radius-sm: 0.25rem;
          --radius-md: 0.5rem;
          --radius-lg: 0.75rem;
          --radius-xl: 1rem;
          --radius-2xl: 1.5rem;
          
          /* Transitions */
          --transition-fast: 150ms ease;
          --transition-normal: 250ms ease;
          --transition-slow: 350ms ease;
          
          /* Z-index */
          --z-dropdown: 1000;
          --z-modal: 1050;
          --z-toast: 1100;
        }

        /* Dark Theme */
        [data-theme="dark"] {
          --bg-primary: #1a202c;
          --bg-secondary: #2d3748;
          --bg-tertiary: #4a5568;
          --text-primary: #f7fafc;
          --text-secondary: #e2e8f0;
          --text-muted: #a0aec0;
          --border-color: #4a5568;
          --shadow-light: 0 1px 3px rgba(0,0,0,0.3);
          --shadow-medium: 0 4px 6px rgba(0,0,0,0.3);
          --shadow-heavy: 0 10px 15px rgba(0,0,0,0.3);
        }

        /* ===== RESET & BASE STYLES ===== */
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        html {
          font-size: 16px;
          scroll-behavior: smooth;
        }

        body {
          font-family: var(--font-family);
          font-size: var(--font-size-base);
          line-height: 1.6;
          color: var(--text-primary);
          background: var(--bg-secondary);
          overflow-x: hidden;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }

        /* ===== LOADING SCREEN ===== */
        .loading-screen {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: var(--primary-gradient);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          transition: opacity var(--transition-slow), visibility var(--transition-slow);
        }

        .loading-screen.hidden {
          opacity: 0;
          visibility: hidden;
        }

        .loading-content {
          text-align: center;
          color: white;
        }

        .trophy-loader {
          font-size: 4rem;
          animation: bounce 1.5s infinite;
          margin-bottom: var(--spacing-lg);
        }

        .loading-bar {
          width: 200px;
          height: 4px;
          background: rgba(255,255,255,0.3);
          border-radius: var(--radius-lg);
          overflow: hidden;
          margin-top: var(--spacing-lg);
        }

        .loading-progress {
          width: 0%;
          height: 100%;
          background: white;
          border-radius: var(--radius-lg);
          animation: loading 2s ease-in-out infinite;
        }

        @keyframes bounce {
          0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
          40% { transform: translateY(-10px); }
          60% { transform: translateY(-5px); }
        }

        @keyframes loading {
          0% { width: 0%; }
          50% { width: 70%; }
          100% { width: 100%; }
        }

        /* ===== MAIN APP LAYOUT ===== */
        .app {
          min-height: 100vh;
          display: flex;
          flex-direction: column;
          transition: opacity var(--transition-slow);
        }

        .app.hidden {
          opacity: 0;
          visibility: hidden;
        }

        /* ===== HEADER ===== */
        .header {
          background: var(--bg-primary);
          box-shadow: var(--shadow-light);
          position: sticky;
          top: 0;
          z-index: 100;
          border-bottom: 1px solid var(--border-color);
        }

        .header-content {
          max-width: 1200px;
          margin: 0 auto;
          padding: var(--spacing-lg) var(--spacing-xl);
          display: flex;
          align-items: center;
          justify-content: space-between;
        }

        .logo-section {
          display: flex;
          align-items: center;
          gap: var(--spacing-lg);
        }

        .trophy-icon {
          font-size: 3rem;
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.05); }
        }

        .title-section h1 {
          font-size: var(--font-size-3xl);
          font-weight: 800;
          background: var(--primary-gradient);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          margin-bottom: var(--spacing-xs);
        }

        .subtitle {
          color: var(--text-secondary);
          font-weight: 500;
        }

        .header-actions {
          display: flex;
          align-items: center;
          gap: var(--spacing-md);
        }

        .icon-btn {
          width: 44px;
          height: 44px;
          border: none;
          border-radius: var(--radius-lg);
          background: var(--bg-secondary);
          color: var(--text-primary);
          font-size: var(--font-size-lg);
          cursor: pointer;
          transition: all var(--transition-fast);
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .icon-btn:hover {
          background: var(--bg-tertiary);
          transform: translateY(-2px);
        }

        .install-btn {
          background: var(--success-gradient);
          color: white;
          border: none;
          padding: var(--spacing-sm) var(--spacing-lg);
          border-radius: var(--radius-lg);
          font-weight: 600;
          cursor: pointer;
          transition: all var(--transition-fast);
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);
        }

        .install-btn:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-medium);
        }

        /* ===== NAVIGATION ===== */
        .navigation {
          background: var(--bg-primary);
          border-bottom: 1px solid var(--border-color);
          position: sticky;
          top: 0;
          z-index: 99;
        }

        .nav-container {
          max-width: 1200px;
          margin: 0 auto;
          display: flex;
          padding: 0 var(--spacing-xl);
        }

        .nav-tab {
          flex: 1;
          padding: var(--spacing-lg) var(--spacing-md);
          border: none;
          background: transparent;
          color: var(--text-secondary);
          cursor: pointer;
          transition: all var(--transition-fast);
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: var(--spacing-xs);
          position: relative;
          overflow: hidden;
        }

        .nav-tab::before {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 3px;
          background: var(--primary-gradient);
          transform: translateX(-100%);
          transition: transform var(--transition-normal);
        }

        .nav-tab.active::before {
          transform: translateX(0);
        }

        .nav-tab.active {
          color: var(--primary-color);
          background: rgba(102, 126, 234, 0.05);
        }

        .nav-tab:hover:not(.active) {
          background: var(--bg-secondary);
          color: var(--text-primary);
        }

        .nav-icon {
          font-size: var(--font-size-lg);
        }

        .nav-text {
          font-size: var(--font-size-sm);
          font-weight: 600;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
          flex: 1;
          max-width: 1200px;
          margin: 0 auto;
          width: 100%;
          padding: var(--spacing-xl);
        }

        .tab-content {
          display: none;
          animation: fadeInUp var(--transition-normal) ease-out;
        }

        .tab-content.active {
          display: block;
        }

        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .content-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: var(--spacing-2xl);
          flex-wrap: wrap;
          gap: var(--spacing-lg);
        }

        .content-header h2 {
          font-size: var(--font-size-2xl);
          font-weight: 700;
          color: var(--text-primary);
        }

        /* ===== BUTTONS ===== */
        .btn {
          display: inline-flex;
          align-items: center;
          gap: var(--spacing-sm);
          padding: var(--spacing-md) var(--spacing-lg);
          border: none;
          border-radius: var(--radius-lg);
          font-weight: 600;
          font-size: var(--font-size-sm);
          cursor: pointer;
          transition: all var(--transition-fast);
          text-decoration: none;
          position: relative;
          overflow: hidden;
        }

        .btn.primary {
          background: var(--primary-gradient);
          color: white;
        }

        .btn.primary:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-medium);
        }

        .btn.secondary {
          background: var(--bg-primary);
          color: var(--text-primary);
          border: 2px solid var(--border-color);
        }

        .btn.secondary:hover {
          border-color: var(--primary-color);
          color: var(--primary-color);
          transform: translateY(-2px);
        }

        .btn.success {
          background: var(--success-gradient);
          color: white;
        }

        .btn.success:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-medium);
        }

        .btn.danger {
          background: var(--danger-gradient);
          color: white;
        }

        .btn.danger:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-medium);
        }

        /* ===== CSV IMPORT SECTION ===== */
        .csv-import-section {
          background: var(--bg-primary);
          padding: var(--spacing-xl);
          border-radius: var(--radius-xl);
          box-shadow: var(--shadow-light);
          border: 1px solid var(--border-color);
          margin-bottom: var(--spacing-2xl);
          text-align: center;
        }

        .csv-import-section.hidden {
          display: none;
        }

        .csv-import-section h3 {
          color: var(--primary-color);
          margin-bottom: var(--spacing-lg);
          font-size: var(--font-size-xl);
        }

        .csv-import-section p {
          color: var(--text-secondary);
          margin-bottom: var(--spacing-lg);
        }

        .import-status {
          padding: var(--spacing-md);
          border-radius: var(--radius-lg);
          margin: var(--spacing-lg) 0;
          font-weight: 600;
        }

        .import-status.success {
          background: rgba(76, 175, 80, 0.1);
          color: var(--success-color);
        }

        .import-status.error {
          background: rgba(255, 71, 87, 0.1);
          color: var(--danger-color);
        }

        .import-status.info {
          background: rgba(102, 126, 234, 0.1);
          color: var(--primary-color);
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
          display: none !important;
        }

        .text-center {
          text-align: center;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
          .header-content {
            flex-direction: column;
            gap: var(--spacing-lg);
            text-align: center;
          }
          
          .nav-text {
            display: none;
          }
          
          .title-section h1 {
            font-size: var(--font-size-xl);
          }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="trophy-loader">üèÜ</div>
            <h2>Laddar Pekkas Pokal...</h2>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="app hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <span class="trophy-icon">üèÜ</span>
                    <div class="title-section">
                        <h1>Pekkas Pokal</h1>
                        <p class="subtitle">√Örlig T√§vling ‚Ä¢ <span id="year-range">2011-2024</span></p>
                    </div>
                </div>
                
                <div class="header-actions">
                    <button id="theme-toggle" class="icon-btn" title="V√§xla tema">üåô</button>
                    <button id="fullscreen-toggle" class="icon-btn" title="Helsk√§rm">‚õ∂</button>
                    <button id="install-btn" class="install-btn hidden" title="Installera app">üì± Installera</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="navigation">
            <div class="nav-container">
                <button class="nav-tab active" data-tab="results">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">√Örliga Resultat</span>
                </button>
                <button class="nav-tab" data-tab="statistics">
                    <span class="nav-icon">üìà</span>
                    <span class="nav-text">Statistik</span>
                </button>
                <button class="nav-tab" data-tab="participants">
                    <span class="nav-icon">üë•</span>
                    <span class="nav-text">Deltagare</span>
                </button>
                <button class="nav-tab" data-tab="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Inst√§llningar</span>
                </button>
            </div>
        </nav>

        <!-- CSV Import Section (shown initially) -->
        <div id="csv-import-section" class="csv-import-section">
            <h3>üèÜ V√§lkommen till Pekkas Pokal!</h3>
            <p>Importera dina t√§vlingsdata f√∂r att komma ig√•ng</p>
            <div id="import-status" class="import-status info">
                V√§lj din CSV-fil f√∂r att importera t√§vlingsdata
            </div>
            <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
            <button id="import-csv-btn" class="btn success">
                üìä Importera T√§vlingsdata
            </button>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Results Tab -->
            <section id="results-tab" class="tab-content active">
                <div class="content-header">
                    <h2>T√§vlingsresultat per √Ör</h2>
                    <button id="add-competition" class="btn primary">
                        <span>‚ûï</span> Ny T√§vling
                    </button>
                </div>
                
                <div id="results-content">
                    <div class="text-center">
                        <p>Importera CSV-data f√∂r att visa t√§vlingsresultat</p>
                    </div>
                </div>
            </section>

            <!-- Statistics Tab -->
            <section id="statistics-tab" class="tab-content">
                <div class="content-header">
                    <h2>Omfattande Statistik</h2>
                </div>
                <div id="statistics-content">
                    <div class="text-center">
                        <p>Statistik visas efter import av t√§vlingsdata</p>
                    </div>
                </div>
            </section>

            <!-- Participants Tab -->
            <section id="participants-tab" class="tab-content">
                <div class="content-header">
                    <h2>Deltagarhantering</h2>
                    <button id="add-participant" class="btn primary">
                        <span>‚ûï</span> L√§gg till Deltagare
                    </button>
                </div>
                <div id="participants-content">
                    <div class="text-center">
                        <p>Deltagare visas efter import av t√§vlingsdata</p>
                    </div>
                </div>
            </section>

            <!-- Settings Tab -->
            <section id="settings-tab" class="tab-content">
                <div class="content-header">
                    <h2>Inst√§llningar & Datahantering</h2>
                </div>
                <div id="settings-content">
                    <div class="text-center">
                        <p>Inst√§llningar blir tillg√§ngliga efter import</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Container for Notifications -->
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1100; display: flex; flex-direction: column; gap: 0.5rem; max-width: 400px;"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    
    <script>
        // Fixed CSV Import and App Initialization
        class PekkasPokalkApp {
            constructor() {
                this.competitions = [];
                this.participants = [];
                this.isInitialized = false;
                this.currentTab = 'results';
                
                this.init();
            }
            
            async init() {
                this.showLoadingScreen();
                this.setupEventListeners();
                
                // Check if data exists
                const existingData = localStorage.getItem('pekkas-pokal-data');
                if (existingData) {
                    await this.loadExistingData();
                    this.hideCSVImport();
                } else {
                    this.showCSVImport();
                }
                
                this.hideLoadingScreen();
            }
            
            setupEventListeners() {
                // CSV Import - Fixed to use proper file selection
                document.getElementById('import-csv-btn').addEventListener('click', () => {
                    document.getElementById('csv-file-input').click();
                });
                
                document.getElementById('csv-file-input').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.importCSVData(e.target.files[0]);
                    }
                });
                
                // Navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const targetTab = e.target.closest('.nav-tab').dataset.tab;
                        this.switchTab(targetTab);
                    });
                });
                
                // Theme toggle
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    this.toggleTheme();
                });
                
                // Fullscreen
                document.getElementById('fullscreen-toggle').addEventListener('click', () => {
                    this.toggleFullscreen();
                });
            }
            
            async importCSVData(file) {
                const statusEl = document.getElementById('import-status');
                const btnEl = document.getElementById('import-csv-btn');
                
                if (!file) {
                    statusEl.textContent = '‚ùå Ingen fil vald';
                    statusEl.className = 'import-status error';
                    return;
                }
                
                try {
                    statusEl.textContent = 'L√§ser CSV-fil...';
                    statusEl.className = 'import-status info';
                    btnEl.textContent = '‚è≥ Importerar...';
                    btnEl.disabled = true;
                    
                    // Read file content using FileReader (browser-compatible)
                    const csvContent = await this.readFileAsText(file);
                    
                    statusEl.textContent = 'Bearbetar data...';
                    
                    // Parse CSV
                    const parsedData = Papa.parse(csvContent, {
                        header: true,
                        dynamicTyping: false,
                        skipEmptyLines: true
                    });
                    
                    if (parsedData.errors.length > 0) {
                        console.warn('CSV parsing errors:', parsedData.errors);
                    }
                    
                    // Convert to app format
                    await this.convertCSVToAppData(parsedData);
                    
                    // Save data
                    this.saveData();
                    
                    // Initialize app with data
                    this.initializeApp();
                    
                    statusEl.textContent = `‚úÖ Import slutf√∂rd! ${this.competitions.length} t√§vlingar och ${this.participants.length} deltagare importerade.`;
                    statusEl.className = 'import-status success';
                    
                    // Hide import section after delay
                    setTimeout(() => {
                        this.hideCSVImport();
                        btnEl.textContent = 'üìä Importera T√§vlingsdata';
                        btnEl.disabled = false;
                    }, 3000);
                    
                } catch (error) {
                    console.error('Import failed:', error);
                    statusEl.textContent = `‚ùå Import misslyckades: ${error.message}`;
                    statusEl.className = 'import-status error';
                    btnEl.textContent = 'üìä Importera T√§vlingsdata';
                    btnEl.disabled = false;
                }
            }
            
            // Fixed FileReader implementation for browser compatibility
            readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error('Kunde inte l√§sa filen'));
                    reader.readAsText(file, 'UTF-8');
                });
            }
            
            async convertCSVToAppData(parsedData) {
                // Extract participant columns (excluding √Ör, T√§vling, Plats)
                const participantColumns = parsedData.meta.fields.slice(3);
                
                // Create participants
                this.participants = participantColumns.map(name => ({
                    id: this.generateId('participant'),
                    name: name.trim(),
                    nickname: this.getNameParts(name).nickname,
                    status: 'active',
                    createdAt: new Date().toISOString()
                }));
                
                // Create participant ID map
                const participantIdMap = {};
                this.participants.forEach(p => {
                    participantIdMap[p.name] = p.id;
                });
                
                // Process competitions
                this.competitions = [];
                
                for (const row of parsedData.data) {
                    const year = parseInt(row['√Ör']);
                    const name = row['T√§vling']?.trim();
                    const location = row['Plats']?.trim() || '';
                    
                    if (!year || !name) continue;
                    
                    const scores = {};
                    let winner = null;
                    let bestPosition = null;
                    
                    participantColumns.forEach(participantName => {
                        const scoreValue = row[participantName]?.toString()?.trim();
                        if (scoreValue && scoreValue !== '' && scoreValue !== '-') {
                            const position = this.parsePosition(scoreValue);
                            if (position !== null) {
                                const participantId = participantIdMap[participantName];
                                scores[participantId] = position;
                                
                                if (position === 1) {
                                    winner = participantName;
                                } else if (!winner && (bestPosition === null || position < bestPosition)) {
                                    bestPosition = position;
                                    winner = participantName;
                                }
                            }
                        }
                    });
                    
                    this.competitions.push({
                        id: this.generateId('competition'),
                        year: year,
                        name: name,
                        location: location,
                        winner: winner,
                        scores: scores,
                        createdAt: new Date().toISOString()
                    });
                }
                
                // Sort competitions by year
                this.competitions.sort((a, b) => b.year - a.year);
            }
            
            parsePosition(value) {
                if (!value || value === '-' || value === '') return null;
                
                const numValue = parseInt(value);
                if (!isNaN(numValue) && numValue > 0) {
                    return numValue;
                }
                
                // Handle Swedish text
                const textValue = value.toLowerCase().trim();
                if (textValue.includes('n√§st sist')) return 99; // Will be adjusted later
                if (textValue === 'sist') return 100;
                
                return null;
            }
            
            getNameParts(fullName) {
                const parts = fullName.trim().split(' ');
                const firstName = parts[0];
                const lastName = parts[parts.length - 1];
                
                return {
                    firstName: firstName,
                    lastName: lastName,
                    nickname: firstName + ' ' + lastName.charAt(0) + '.'
                };
            }
            
            generateId(prefix = 'id') {
                return `${prefix}_${Math.random().toString(36).substr(2, 9)}_${Date.now().toString(36)}`;
            }
            
            saveData() {
                const data = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    competitions: this.competitions,
                    participants: this.participants
                };
                
                localStorage.setItem('pekkas-pokal-data', JSON.stringify(data));
            }
            
            async loadExistingData() {
                const data = JSON.parse(localStorage.getItem('pekkas-pokal-data'));
                this.competitions = data.competitions || [];
                this.participants = data.participants || [];
                this.initializeApp();
            }
            
            initializeApp() {
                this.renderResults();
                this.renderParticipants();
                this.renderStatistics();
                this.renderSettings();
                this.isInitialized = true;
            }
            
            renderResults() {
                const content = document.getElementById('results-content');
                
                if (this.competitions.length === 0) {
                    content.innerHTML = '<div class="text-center"><p>Inga t√§vlingar att visa √§nnu.</p></div>';
                    return;
                }
                
                let html = `
                    <div style="background: var(--bg-primary); padding: var(--spacing-xl); border-radius: var(--radius-xl); box-shadow: var(--shadow-light); border: 1px solid var(--border-color);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--primary-gradient); color: white;">
                                    <th style="padding: var(--spacing-md); text-align: left;">√Ör</th>
                                    <th style="padding: var(--spacing-md); text-align: left;">T√§vling</th>
                                    <th style="padding: var(--spacing-md); text-align: left;">Plats</th>
                                    <th style="padding: var(--spacing-md); text-align: left;">Vinnare</th>
                                    <th style="padding: var(--spacing-md); text-align: left;">Deltagare</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                this.competitions.forEach(comp => {
                    const participantCount = Object.keys(comp.scores || {}).length;
                    html += `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: var(--spacing-md); font-weight: 700; color: var(--primary-color);">${comp.year}</td>
                            <td style="padding: var(--spacing-md);">${comp.name}</td>
                            <td style="padding: var(--spacing-md); color: var(--text-secondary);">${comp.location || '-'}</td>
                            <td style="padding: var(--spacing-md); font-weight: 600; color: var(--success-color);">${comp.winner || 'TBD'}</td>
                            <td style="padding: var(--spacing-md);">${participantCount} deltagare</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                content.innerHTML = html;
            }
            
            renderParticipants() {
                const content = document.getElementById('participants-content');
                
                if (this.participants.length === 0) {
                    content.innerHTML = '<div class="text-center"><p>Inga deltagare att visa √§nnu.</p></div>';
                    return;
                }
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: var(--spacing-lg);">';
                
                this.participants.forEach(participant => {
                    const participantCompetitions = this.competitions.filter(comp => 
                        comp.scores && comp.scores[participant.id] !== undefined
                    );
                    const wins = this.competitions.filter(comp => comp.winner === participant.name).length;
                    
                    html += `
                        <div style="background: var(--bg-primary); padding: var(--spacing-lg); border-radius: var(--radius-xl); box-shadow: var(--shadow-light); border: 1px solid var(--border-color);">
                            <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-sm);">${participant.name}</h3>
                            <p style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-md);">${participant.nickname}</p>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md);">
                                <div style="text-align: center;">
                                    <div style="font-weight: 700; font-size: var(--font-size-lg); color: var(--primary-color);">${participantCompetitions.length}</div>
                                    <div style="font-size: var(--font-size-xs); color: var(--text-muted);">T√ÑVLINGAR</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: 700; font-size: var(--font-size-lg); color: var(--success-color);">${wins}</div>
                                    <div style="font-size: var(--font-size-xs); color: var(--text-muted);">VINSTER</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                content.innerHTML = html;
            }
            
            renderStatistics() {
                const content = document.getElementById('statistics-content');
                
                if (this.competitions.length === 0) {
                    content.innerHTML = '<div class="text-center"><p>Statistik visas n√§r t√§vlingsdata finns tillg√§nglig.</p></div>';
                    return;
                }
                
                // Calculate basic statistics
                const totalCompetitions = this.competitions.length;
                const totalParticipants = this.participants.length;
                const yearRange = {
                    start: Math.min(...this.competitions.map(c => c.year)),
                    end: Math.max(...this.competitions.map(c => c.year))
                };
                
                // Winner statistics
                const winnerStats = {};
                this.competitions.forEach(comp => {
                    if (comp.winner) {
                        winnerStats[comp.winner] = (winnerStats[comp.winner] || 0) + 1;
                    }
                });
                
                const topWinners = Object.entries(winnerStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-xl); margin-bottom: var(--spacing-2xl);">
                        <div style="background: var(--bg-primary); padding: var(--spacing-xl); border-radius: var(--radius-xl); text-align: center; box-shadow: var(--shadow-light); border: 1px solid var(--border-color);">
                            <h3 style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-md);">TOTALA T√ÑVLINGAR</h3>
                            <div style="font-size: var(--font-size-4xl); font-weight: 900; color: var(--primary-color); margin: var(--spacing-md) 0;">${totalCompetitions}</div>
                            <p style="color: var(--text-muted); font-size: var(--font-size-sm);">Genomf√∂rda t√§vlingar</p>
                        </div>
                        
                        <div style="background: var(--bg-primary); padding: var(--spacing-xl); border-radius: var(--radius-xl); text-align: center; box-shadow: var(--shadow-light); border: 1px solid var(--border-color);">
                            <h3 style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-md);">DELTAGARE</h3>
                            <div style="font-size: var(--font-size-4xl); font-weight: 900; color: var(--primary-color); margin: var(--spacing-md) 0;">${totalParticipants}</div>
                            <p style="color: var(--text-muted); font-size: var(--font-size-sm);">Totalt antal</p>
                        </div>
                        
                        <div style="background: var(--bg-primary); padding: var(--spacing-xl); border-radius: var(--radius-xl); text-align: center; box-shadow: var(--shadow-light); border: 1px solid var(--border-color);">
                            <h3 style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-md);">TIDSSPAN</h3>
                            <div style="font-size: var(--font-size-4xl); font-weight: 900; color: var(--primary-color); margin: var(--spacing-md) 0;">${yearRange.end - yearRange.start + 1}</div>
                            <p style="color: var(--text-muted); font-size: var(--font-size-sm);">${yearRange.start}-${yearRange.end}</p>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-primary); padding: var(--spacing-xl); border-radius: var(--radius-xl); box-shadow: var(--shadow-light); border: 1px solid var(--border-color);">
                        <h3 style="color: var(--text-primary); font-size: var(--font-size-lg); margin-bottom: var(--spacing-lg);">üèÜ Flest Vinster</h3>
                        <div style="display: grid; gap: var(--spacing-md);">
                `;
                
                topWinners.forEach(([winner, wins], index) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-lg);">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                                <span style="font-size: var(--font-size-lg);">${medals[index] || 'üèÖ'}</span>
                                <span style="font-weight: 600; color: var(--text-primary);">${winner}</span>
                            </div>
                            <span style="font-weight: 700; color: var(--primary-color);">${wins} vinster</span>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
            }
            
            renderSettings() {
                const content = document.getElementById('settings-content');
                
                const storageSize = localStorage.getItem('pekkas-pokal-data')?.length || 0;
                const formattedSize = this.formatBytes(storageSize);
                
                content.innerHTML = `
                    <div style="display: grid; gap: var(--spacing-2xl);">
                        <div style="background: var(--bg-primary); padding: var(--spacing-xl); border-radius: var(--radius-xl); box-shadow: var(--shadow-light); border: 1px solid var(--border-color);">
                            <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-lg);">üíæ Datahantering</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
                                <button onclick="app.exportData()" class="btn secondary">
                                    <span>üì¶</span> Exportera Data
                                </button>
                                <button onclick="app.clearData()" class="btn danger">
                                    <span>üóëÔ∏è</span> Rensa All Data
                                </button>
                            </div>
                            <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-lg);">
                                <p><strong>Lagrad data:</strong> ${formattedSize}</p>
                                <p><strong>T√§vlingar:</strong> ${this.competitions.length}</p>
                                <p><strong>Deltagare:</strong> ${this.participants.length}</p>
                            </div>
                        </div>
                        
                        <div style="background: var(--bg-primary); padding: var(--spacing-xl); border-radius: var(--radius-xl); box-shadow: var(--shadow-light); border: 1px solid var(--border-color);">
                            <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-lg);">‚ÑπÔ∏è Om Appen</h3>
                            <p><strong>Pekkas Pokal</strong> v2.0</p>
                            <p>Modern t√§vlingssp√•rning f√∂r v√§nner</p>
                            <p>Utvecklad med ‚ù§Ô∏è f√∂r fair play och kul t√§vlingar</p>
                        </div>
                    </div>
                `;
            }
            
            switchTab(tabName) {
                // Update navigation
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                this.currentTab = tabName;
            }
            
            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                document.getElementById('theme-toggle').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            }
            
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
            
            showLoadingScreen() {
                document.getElementById('loading-screen').classList.remove('hidden');
            }
            
            hideLoadingScreen() {
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                }, 1000);
            }
            
            showCSVImport() {
                document.getElementById('csv-import-section').classList.remove('hidden');
            }
            
            hideCSVImport() {
                document.getElementById('csv-import-section').classList.add('hidden');
            }
            
            showNotification(message, type = 'info', duration = 5000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                
                toast.style.cssText = `
                    background: var(--bg-primary);
                    color: var(--text-primary);
                    padding: var(--spacing-lg);
                    border-radius: var(--radius-lg);
                    box-shadow: var(--shadow-heavy);
                    border: 1px solid var(--border-color);
                    border-left: 4px solid var(--${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'primary'}-color);
                    transform: translateX(calc(100% + 20px));
                    transition: transform 0.25s ease;
                    display: flex;
                    align-items: center;
                    gap: var(--spacing-md);
                `;
                
                toast.innerHTML = `
                    <span style="font-size: var(--font-size-lg);">${icons[type] || icons.info}</span>
                    <span>${message}</span>
                `;
                
                container.appendChild(toast);
                
                // Show with animation
                setTimeout(() => {
                    toast.style.transform = 'translateX(0)';
                }, 100);
                
                // Auto remove
                setTimeout(() => {
                    toast.style.transform = 'translateX(calc(100% + 20px))';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            }
            
            async exportData() {
                try {
                    const data = {
                        version: '2.0',
                        exportDate: new Date().toISOString(),
                        competitions: this.competitions,
                        participants: this.participants
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `pekkas-pokal-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    this.showNotification('Data exporterad!', 'success');
                } catch (error) {
                    console.error('Export failed:', error);
                    this.showNotification('Fel vid export', 'error');
                }
            }
            
            clearData() {
                if (confirm('√Ñr du s√§ker p√• att du vill rensa all data? Detta kan inte √•ngras.')) {
                    localStorage.removeItem('pekkas-pokal-data');
                    location.reload();
                }
            }
            
            formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
        }
        
        // Initialize the application
        let app;
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                app = new PekkasPokalkApp();
            });
        } else {
            app = new PekkasPokalkApp();
        }
        
        // PWA Installation
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const installBtn = document.getElementById('install-btn');
            installBtn.classList.remove('hidden');
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    installBtn.classList.add('hidden');
                }
            });
        });
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>