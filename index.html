<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèÜ Pekkas Pokal - Ultimate Competition Tracker</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="√Örlig t√§vling f√∂r v√§nner med omfattande statistik och datahantering">
  <link rel="manifest" href="manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÜ</text></svg>">
  
  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ===== THEME & VARIABLES ===== */
    :root {
      --gold: linear-gradient(135deg, #FFD700, #FFA500);
      --silver: linear-gradient(135deg, #C0C0C0, #808080);
      --bronze: linear-gradient(135deg, #CD7F32, #8B4513);
      --epic-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --fire-gradient: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      --ice-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --nature-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      
      --bg-dark: #0f0f23;
      --bg-card: #1a1a2e;
      --bg-card-hover: #16213e;
      --text-primary: #ffffff;
      --text-secondary: #a8b2d1;
      --text-muted: #64748b;
      --accent: #667eea;
      --success: #4ade80;
      --danger: #f87171;
      --warning: #fbbf24;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
    }

    /* ===== LOADING SCREEN ===== */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--epic-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-content {
      text-align: center;
      color: white;
    }

    .trophy-loader {
      font-size: 4rem;
      animation: bounce 1.5s infinite;
      margin-bottom: 1rem;
    }

    .loading-bar {
      width: 200px;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loading-progress {
      width: 0%;
      height: 100%;
      background: white;
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    /* ===== HEADER ===== */
    .header {
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid rgba(102, 126, 234, 0.3);
      padding: 1.5rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .trophy-logo {
      font-size: 2.5rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.1) rotate(5deg); }
    }

    .logo h1 {
      font-size: 1.8rem;
      background: var(--epic-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .year-display {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-left: 1rem;
      padding: 0.3rem 0.8rem;
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 20px;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .icon-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    /* ===== NAVIGATION TABS ===== */
    .nav-tabs {
      display: flex;
      gap: 1rem;
      padding: 1rem 2rem;
      background: rgba(26, 26, 46, 0.5);
      border-bottom: 1px solid rgba(102, 126, 234, 0.2);
      overflow-x: auto;
      justify-content: center;
    }

    .nav-tab {
      padding: 0.8rem 1.5rem;
      background: transparent;
      color: var(--text-secondary);
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }

    .nav-tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--epic-gradient);
      opacity: 0.2;
      transition: left 0.3s ease;
    }

    .nav-tab:hover::before {
      left: 0;
    }

    .nav-tab.active {
      background: var(--epic-gradient);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .nav-tab span {
      margin-right: 0.5rem;
    }

    /* ===== MAIN CONTAINER ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== DASHBOARD SECTION ===== */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--epic-gradient);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      border-color: var(--accent);
    }

    .stat-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      background: var(--epic-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0.5rem 0;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-change {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    /* ===== IMPORT SECTION ===== */
    .import-section {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      margin: 2rem 0;
      border: 2px dashed rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
    }

    .import-section.drag-over {
      background: rgba(102, 126, 234, 0.1);
      border-color: var(--accent);
    }

    .import-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .import-title {
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .import-desc {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }

    .import-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .import-btn {
      padding: 1rem 2rem;
      background: var(--epic-gradient);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .import-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .import-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(102, 126, 234, 0.3);
    }

    .import-btn.secondary:hover {
      background: rgba(102, 126, 234, 0.2);
      border-color: var(--accent);
    }

    .import-status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 12px;
      display: none;
    }

    .import-status.success {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .import-status.error {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
    }

    /* ===== MOBILE RESPONSIVE ===== */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .nav-tabs {
        padding: 1rem;
        justify-content: flex-start;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .import-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .import-btn {
        width: 100%;
        justify-content: center;
      }

      .container {
        padding: 1rem;
      }
    }

    /* ===== LOADING STATE ===== */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    /* ===== TOAST NOTIFICATIONS ===== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 400px;
    }

    .toast {
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      border-left: 4px solid var(--success);
      transform: translateX(calc(100% + 20px));
      transition: transform 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success { border-left-color: var(--success); }
    .toast.warning { border-left-color: var(--warning); }
    .toast.error { border-left-color: var(--danger); }
    .toast.info { border-left-color: var(--accent); }

    .toast-content {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .toast-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .toast-message {
      flex: 1;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .toast-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="loading-content">
      <div class="trophy-loader">üèÜ</div>
      <h2>Pekkas Pokal</h2>
      <p>Laddar t√§vlingsdata...</p>
      <div class="loading-bar">
        <div class="loading-progress"></div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="app hidden">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <span class="trophy-logo">üèÜ</span>
          <h1>Pekkas Pokal</h1>
          <span class="year-display" id="year-range">2011-2024</span>
        </div>
        
        <div class="header-actions">
          <button id="cache-control-btn" class="icon-btn" title="Cache Control (Ctrl+Shift+C)">üîß</button>
          <button id="theme-toggle" class="icon-btn" title="V√§xla tema">üåô</button>
          <button id="fullscreen-toggle" class="icon-btn" title="Fullsk√§rm">‚õ∂</button>
          <button id="install-btn" class="icon-btn hidden" title="Installera app">üì±</button>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="dashboard"><span>üìä</span> Dashboard</button>
      <button class="nav-tab" data-tab="import"><span>üìÅ</span> Importera</button>
      <button class="nav-tab" data-tab="statistics"><span>üìà</span> Statistik</button>
      <button class="nav-tab" data-tab="settings"><span>‚öôÔ∏è</span> Inst√§llningar</button>
    </nav>

    <!-- Main Container -->
    <div class="container">
      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-content active">
        <div class="dashboard-grid">
          <div class="stat-card">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-value counter" id="total-competitions">0</div>
            <div class="stat-label">T√§vlingar</div>
            <div class="stat-change" id="comp-change">
              <span>‚Üí</span> Laddar data...
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-value counter" id="total-participants">0</div>
            <div class="stat-label">Deltagare</div>
            <div class="stat-change" id="part-change">
              <span>‚Üí</span> Laddar data...
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">üî•</div>
            <div class="stat-value" id="current-champion">‚Äî</div>
            <div class="stat-label">Senaste Vinnare</div>
            <div class="stat-change" id="champ-change">
              <span>üéØ</span> Laddar...
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">üëë</div>
            <div class="stat-value" id="most-wins">‚Äî</div>
            <div class="stat-label">Flest Vinster</div>
            <div class="stat-change" id="wins-change">
              <span>üèÖ</span> Laddar...
            </div>
          </div>
        </div>

        <!-- Welcome message for new users -->
        <div id="welcome-section" class="import-section">
          <div class="import-icon">üéâ</div>
          <h2 class="import-title">V√§lkommen till Pekkas Pokal!</h2>
          <p class="import-desc">
            F√∂r att komma ig√•ng, v√§lj ett av alternativen nedan f√∂r att ladda t√§vlingsdata.
          </p>
          <div class="import-actions">
            <button id="load-default-btn" class="import-btn">
              <span>üèÜ</span> Ladda Standarddata
            </button>
            <button id="go-to-import-btn" class="import-btn secondary">
              <span>üìÅ</span> Importera CSV
            </button>
          </div>
        </div>
      </div>

      <!-- Import Tab -->
      <div id="import" class="tab-content">
        <div class="import-section" id="import-drop-zone">
          <div class="import-icon">üìÅ</div>
          <div class="import-title">Importera T√§vlingsdata</div>
          <div class="import-desc">
            Dra och sl√§pp din CSV-fil h√§r eller v√§lj en av alternativen nedan
          </div>
          
          <div class="import-actions">
            <button class="import-btn" onclick="document.getElementById('csv-file').click()">
              <span>üìÑ</span> V√§lj CSV-fil
            </button>
            <button id="load-google-sheets-btn" class="import-btn secondary">
              <span>üìä</span> Ladda fr√•n Google Sheets
            </button>
            <button id="load-default-data-btn" class="import-btn secondary">
              <span>üèÜ</span> Ladda Standarddata
            </button>
          </div>
          
          <input type="file" id="csv-file" accept=".csv" style="display: none;">
          
          <div id="import-status" class="import-status"></div>
          
          <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid rgba(102, 126, 234, 0.2); text-align: left;">
            <h3 style="color: var(--text-primary); margin-bottom: 1rem;">üìã Instruktioner:</h3>
            <div style="color: var(--text-secondary); line-height: 1.6;">
              <p><strong>CSV-format:</strong> Filen ska ha kolumnerna √Ör, T√§vling, Plats, f√∂ljt av deltagarnamn.</p>
              <p><strong>Google Sheets:</strong> G√∂r ditt sheet publikt och anv√§nd Sheet ID fr√•n URL:en.</p>
              <p><strong>Standarddata:</strong> Laddar exempel-t√§vlingar f√∂r att komma ig√•ng snabbt.</p>
              <p><strong>Fels√∂kning:</strong> Tryck Ctrl+Shift+C f√∂r cache-kontroll om n√•got inte fungerar.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistics Tab -->
      <div id="statistics" class="tab-content">
        <div class="loading">
          <div class="spinner"></div>
        </div>
        <p style="text-align: center; color: var(--text-secondary); margin-top: 1rem;">
          Statistik kommer att visas n√§r data har laddats
        </p>
      </div>

      <!-- Settings Tab -->
      <div id="settings" class="tab-content">
        <div class="import-section">
          <div class="import-icon">‚öôÔ∏è</div>
          <h2 class="import-title">Inst√§llningar & Verktyg</h2>
          
          <div class="import-actions">
            <button id="settings-cache-control" class="import-btn">
              <span>üîß</span> Cache Control
            </button>
            <button id="settings-hard-refresh" class="import-btn secondary">
              <span>üîÑ</span> Hard Refresh
            </button>
            <button id="settings-clear-data" class="import-btn secondary">
              <span>üóëÔ∏è</span> Rensa All Data
            </button>
          </div>
          
          <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid rgba(102, 126, 234, 0.2); text-align: left;">
            <h3 style="color: var(--text-primary); margin-bottom: 1rem;">‚å®Ô∏è Kortkommandon:</h3>
            <div style="color: var(--text-secondary); line-height: 1.8;">
              <p><code>Ctrl+Shift+C</code> - √ñppna cache control panel</p>
              <p><code>Ctrl+Shift+R</code> - Hard refresh (kringg√•r cache)</p>
              <p><code>F11</code> - Fullsk√§rmsl√§ge</p>
            </div>
            
            <h3 style="color: var(--text-primary); margin: 2rem 0 1rem 0;">üõ†Ô∏è Utvecklarverktyg:</h3>
            <div style="color: var(--text-secondary); line-height: 1.8;">
              <p>√ñppna browser console (F12) f√∂r avancerade funktioner:</p>
              <p><code>loadDefaultData()</code> - Ladda standarddata</p>
              <p><code>importCSVIntoApp()</code> - Importera CSV</p>
              <p><code>clearAllCaches()</code> - Rensa alla caches</p>
              <p><code>setGoogleSheetsId('SHEET_ID')</code> - Konfigurera Google Sheets</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Scripts -->
  <!-- Papa Parse for CSV processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
  
  <!-- Our Core Scripts -->
  <script src="scripts/utils.js"></script>
  <script src="scripts/data-manager.js"></script>
  <script src="scripts/statistics.js"></script>
  <script src="scripts/chart-manager.js"></script>
  
  <!-- New Enhanced Scripts -->
  <script src="cache-manager.js"></script>
  <script src="csv-import.js"></script>
  <script src="default-data.js"></script>
  
  <!-- Main Application Script -->
  <script src="scripts/main.js"></script>

  <!-- Application Logic -->
  <script>
    // Global competition data
    let competitionData = {
      competitions: [],
      participants: [],
      scores: {},
      initialized: false
    };

    // Initialize application
    function init() {
      setupTabs();
      setupCSVImport();
      setupEventListeners();
      
      // Check for saved data
      const savedData = localStorage.getItem('pekkas-pokal-data');
      if (savedData) {
        try {
          competitionData = JSON.parse(savedData);
          if (competitionData.initialized) {
            updateAllViews();
            hideWelcomeSection();
          }
        } catch (error) {
          console.error('Failed to load saved data:', error);
        }
      }
    }

    // Tab navigation
    function setupTabs() {
      const tabs = document.querySelectorAll('.nav-tab');
      const contents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          
          tabs.forEach(t => t.classList.remove('active'));
          contents.forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(targetTab).classList.add('active');
        });
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Header buttons
      document.getElementById('cache-control-btn')?.addEventListener('click', () => {
        if (window.showCacheControl) {
          window.showCacheControl();
        }
      });

      document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
      document.getElementById('fullscreen-toggle')?.addEventListener('click', toggleFullscreen);

      // Dashboard buttons
      document.getElementById('load-default-btn')?.addEventListener('click', loadDefaultDataHandler);
      document.getElementById('go-to-import-btn')?.addEventListener('click', () => {
        document.querySelector('[data-tab="import"]').click();
      });

      // Import buttons
      document.getElementById('load-google-sheets-btn')?.addEventListener('click', loadGoogleSheetsHandler);
      document.getElementById('load-default-data-btn')?.addEventListener('click', loadDefaultDataHandler);

      // Settings buttons
      document.getElementById('settings-cache-control')?.addEventListener('click', () => {
        if (window.showCacheControl) {
          window.showCacheControl();
        }
      });

      document.getElementById('settings-hard-refresh')?.addEventListener('click', () => {
        if (window.hardRefresh) {
          window.hardRefresh();
        }
      });

      document.getElementById('settings-clear-data')?.addEventListener('click', clearAllDataHandler);
    }

    // CSV Import setup
    function setupCSVImport() {
      const dropZone = document.getElementById('import-drop-zone');
      const fileInput = document.getElementById('csv-file');

      // Drag and drop
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        const file = e.dataTransfer.files[0];
        if (file) {
          processCSVFile(file);
        }
      });

      // File input
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          processCSVFile(file);
        }
      });
    }

    // Process CSV file
    async function processCSVFile(file) {
      showImportStatus('Bearbetar CSV-fil...', 'info');
      
      try {
        if (!window.csvImporter) {
          throw new Error('CSV importer inte tillg√§nglig');
        }

        const data = await window.csvImporter.importCSVData(file);
        await window.csvImporter.importIntoApp(data);
        
        competitionData = data;
        updateAllViews();
        hideWelcomeSection();
        
        showImportStatus(
          `‚úÖ Import lyckades! ${data.competitions.length} t√§vlingar och ${data.participants.length} deltagare importerade.`,
          'success'
        );

      } catch (error) {
        console.error('CSV import failed:', error);
        showImportStatus(`‚ùå Import misslyckades: ${error.message}`, 'error');
      }
    }

    // Load default data handler
    async function loadDefaultDataHandler() {
      showImportStatus('Laddar standarddata...', 'info');
      
      try {
        if (!window.loadDefaultData) {
          throw new Error('Default data loader inte tillg√§nglig');
        }

        await window.loadDefaultData();
        
        // Reload data
        const savedData = localStorage.getItem('pekkas-pokal-data');
        if (savedData) {
          competitionData = JSON.parse(savedData);
          updateAllViews();
          hideWelcomeSection();
        }
        
        showImportStatus('‚úÖ Standarddata laddad framg√•ngsrikt!', 'success');

      } catch (error) {
        console.error('Default data load failed:', error);
        showImportStatus(`‚ùå Kunde inte ladda standarddata: ${error.message}`, 'error');
      }
    }

    // Load Google Sheets handler
    async function loadGoogleSheetsHandler() {
      const sheetId = prompt(
        'Ange Google Sheets ID fr√•n din URL:\n\n' +
        'Exempel: https://docs.google.com/spreadsheets/d/DENNA_STR√ÑNG/edit\n\n' +
        'Sheet ID:'
      );
      
      if (!sheetId) return;
      
      showImportStatus('Laddar fr√•n Google Sheets...', 'info');
      
      try {
        if (!window.setGoogleSheetsId || !window.loadDefaultData) {
          throw new Error('Google Sheets funktioner inte tillg√§ngliga');
        }

        window.setGoogleSheetsId(sheetId);
        await window.loadDefaultData();
        
        // Reload data
        const savedData = localStorage.getItem('pekkas-pokal-data');
        if (savedData) {
          competitionData = JSON.parse(savedData);
          updateAllViews();
          hideWelcomeSection();
        }
        
        showImportStatus('‚úÖ Google Sheets data laddad framg√•ngsrikt!', 'success');

      } catch (error) {
        console.error('Google Sheets load failed:', error);
        showImportStatus(`‚ùå Google Sheets laddning misslyckades: ${error.message}`, 'error');
      }
    }

    // Clear all data handler
    function clearAllDataHandler() {
      if (confirm('√Ñr du s√§ker p√• att du vill radera all data? Detta kan inte √•ngras.')) {
        localStorage.removeItem('pekkas-pokal-data');
        competitionData = { competitions: [], participants: [], scores: {}, initialized: false };
        updateAllViews();
        showWelcomeSection();
        showNotification('All data rensad', 'success');
      }
    }

    // Update all views
    function updateAllViews() {
      if (!competitionData.initialized) return;
      
      // Update stats cards
      document.getElementById('total-competitions').textContent = competitionData.competitions.length;
      document.getElementById('total-participants').textContent = competitionData.participants.length;
      
      // Find latest winner
      if (competitionData.competitions.length > 0) {
        const latestComp = competitionData.competitions[competitionData.competitions.length - 1];
        document.getElementById('current-champion').textContent = latestComp.winner || '‚Äî';
        document.getElementById('champ-change').innerHTML = `<span>üéØ</span> ${latestComp.name} ${latestComp.year}`;
      }
      
      // Calculate most wins
      const winCounts = {};
      competitionData.competitions.forEach(comp => {
        if (comp.winner) {
          winCounts[comp.winner] = (winCounts[comp.winner] || 0) + 1;
        }
      });
      
      const topWinner = Object.entries(winCounts).sort((a, b) => b[1] - a[1])[0];
      if (topWinner) {
        document.getElementById('most-wins').textContent = topWinner[0];
        document.getElementById('wins-change').innerHTML = `<span>üèÖ</span> ${topWinner[1]} vinster totalt`;
      }

      // Update year range
      if (competitionData.competitions.length > 0) {
        const years = competitionData.competitions.map(c => c.year);
        document.getElementById('year-range').textContent = `${Math.min(...years)}-${Math.max(...years)}`;
      }
    }

    // Show/hide welcome section
    function hideWelcomeSection() {
      const welcomeSection = document.getElementById('welcome-section');
      if (welcomeSection) {
        welcomeSection.style.display = 'none';
      }
    }

    function showWelcomeSection() {
      const welcomeSection = document.getElementById('welcome-section');
      if (welcomeSection) {
        welcomeSection.style.display = 'block';
      }
    }

    // Show import status
    function showImportStatus(message, type) {
      const statusEl = document.getElementById('import-status');
      statusEl.className = `import-status ${type}`;
      statusEl.textContent = message;
      statusEl.style.display = 'block';
      
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 5000);
      }
    }

    // Theme toggle
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      document.getElementById('theme-toggle').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      
      localStorage.setItem('pekkas-pokal-theme', newTheme);
      showNotification(`${newTheme === 'light' ? 'Ljust' : 'M√∂rkt'} tema aktiverat`, 'info');
    }

    // Fullscreen toggle
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    // Show notification
    function showNotification(message, type = 'info', duration = 5000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };
      
      toast.innerHTML = `
        <div class="toast-content">
          <span class="toast-icon">${icons[type] || icons.info}</span>
          <div class="toast-message">${message}</div>
          <button class="toast-close">‚úï</button>
        </div>
      `;
      
      // Close button
      toast.querySelector('.toast-close').addEventListener('click', () => {
        removeToast(toast);
      });
      
      container.appendChild(toast);
      
      // Show with animation
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Auto remove
      setTimeout(() => removeToast(toast), duration);
    }

    // Remove toast notification
    function removeToast(toast) {
      toast.classList.remove('show');
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }

    // Hide loading screen and show app
    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loading-screen');
      const app = document.getElementById('app');
      
      loadingScreen.classList.add('hidden');
      app.classList.remove('hidden');
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      // Load saved theme
      const savedTheme = localStorage.getItem('pekkas-pokal-theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      document.getElementById('theme-toggle').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';

      // Initialize app
      init();
      
      // Hide loading screen after delay
      setTimeout(() => {
        hideLoadingScreen();
        showNotification('V√§lkommen till Pekkas Pokal! üèÜ', 'success');
      }, 1500);
    });

    // Make functions globally available
    window.showNotification = showNotification;
    window.updateAllViews = updateAllViews;
    window.competitionData = competitionData;
  </script>
</body>
</html>