<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèÜ Pekkas Pokal - Ultimate Competition Tracker</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="√Örlig t√§vling f√∂r v√§nner med omfattande statistik och datahantering">
  <link rel="manifest" href="manifest.json">
  
  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* ===== THEME & VARIABLES ===== */
    :root {
      --gold: linear-gradient(135deg, #FFD700, #FFA500);
      --silver: linear-gradient(135deg, #C0C0C0, #808080);
      --bronze: linear-gradient(135deg, #CD7F32, #8B4513);
      --epic-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --fire-gradient: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      --ice-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --nature-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      
      --bg-dark: #0f0f23;
      --bg-card: #1a1a2e;
      --bg-card-hover: #16213e;
      --text-primary: #ffffff;
      --text-secondary: #a8b2d1;
      --text-muted: #64748b;
      --accent: #667eea;
      --success: #4ade80;
      --danger: #f87171;
      --warning: #fbbf24;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
    }

    /* ===== HEADER ===== */
    .header {
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid rgba(102, 126, 234, 0.3);
      padding: 1.5rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .trophy-logo {
      font-size: 2.5rem;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.1) rotate(5deg); }
    }

    .logo h1 {
      font-size: 1.8rem;
      background: var(--epic-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .year-display {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-left: 1rem;
      padding: 0.3rem 0.8rem;
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 20px;
    }

    /* Add Cache Control Button */
    .header-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .icon-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    /* ===== NAVIGATION TABS ===== */
    .nav-tabs {
      display: flex;
      gap: 1rem;
      padding: 1rem 2rem;
      background: rgba(26, 26, 46, 0.5);
      border-bottom: 1px solid rgba(102, 126, 234, 0.2);
      overflow-x: auto;
      justify-content: center;
    }

    .nav-tab {
      padding: 0.8rem 1.5rem;
      background: transparent;
      color: var(--text-secondary);
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }

    .nav-tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--epic-gradient);
      opacity: 0.2;
      transition: left 0.3s ease;
    }

    .nav-tab:hover::before {
      left: 0;
    }

    .nav-tab.active {
      background: var(--epic-gradient);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .nav-tab span {
      margin-right: 0.5rem;
    }

    /* ===== MAIN CONTAINER ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== DASHBOARD SECTION ===== */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--epic-gradient);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      border-color: var(--accent);
    }

    .stat-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      background: var(--epic-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0.5rem 0;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-change {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    /* ===== LEADERBOARD ===== */
    .leaderboard {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    }

    .leaderboard-title {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .leaderboard-filters {
      display: flex;
      gap: 0.5rem;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85rem;
    }

    .filter-btn:hover,
    .filter-btn.active {
      background: var(--epic-gradient);
      color: white;
      transform: translateY(-2px);
    }

    .leaderboard-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      border: 1px solid rgba(102, 126, 234, 0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .leaderboard-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: transparent;
      transition: all 0.3s ease;
    }

    .leaderboard-item:hover {
      transform: translateX(10px);
      background: rgba(102, 126, 234, 0.1);
      border-color: var(--accent);
    }

    .leaderboard-item.gold::before { background: var(--gold); }
    .leaderboard-item.silver::before { background: var(--silver); }
    .leaderboard-item.bronze::before { background: var(--bronze); }

    .position {
      font-size: 1.5rem;
      font-weight: bold;
      width: 50px;
      text-align: center;
      color: var(--text-secondary);
    }

    .position.gold { 
      background: var(--gold);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .position.silver {
      background: var(--silver);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .position.bronze {
      background: var(--bronze);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .player-info {
      flex: 1;
      margin-left: 1rem;
    }

    .player-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .player-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .player-score {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--accent);
      margin-left: auto;
    }

    .trophy-count {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-left: 1rem;
    }

    .trophy {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      padding: 0.3rem 0.6rem;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 12px;
      font-size: 0.9rem;
    }

    /* ===== ACHIEVEMENTS ===== */
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }

    .achievement {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .achievement.unlocked {
      border-color: var(--accent);
      background: rgba(102, 126, 234, 0.1);
    }

    .achievement.locked {
      opacity: 0.5;
      filter: grayscale(100%);
    }

    .achievement:hover {
      transform: scale(1.05);
    }

    .achievement-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .achievement-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }

    .achievement-desc {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .achievement.legendary {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1));
      border-color: gold;
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
      50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); }
    }

    /* ===== CHARTS ===== */
    .chart-container {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1rem 0;
      height: 400px;
      position: relative;
    }

    .chart-container canvas {
      max-height: 350px !important;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .chart-options {
      display: flex;
      gap: 0.5rem;
    }

    /* ===== RECORDS SECTION ===== */
    .records-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }

    .record-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.2rem;
      border: 1px solid rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .record-card::after {
      content: 'üìú';
      position: absolute;
      bottom: -10px;
      right: -10px;
      font-size: 3rem;
      opacity: 0.1;
    }

    .record-card:hover {
      transform: translateY(-3px);
      border-color: var(--accent);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    .record-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }

    .record-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 0.3rem;
    }

    .record-holder {
      font-size: 1rem;
      color: var(--text-primary);
    }

    .record-date {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
    }

    /* ===== FUN STATS ===== */
    .fun-stats {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(240, 147, 251, 0.1));
      border-radius: 16px;
      padding: 1.5rem;
      margin: 2rem 0;
      border: 2px solid rgba(102, 126, 234, 0.3);
    }

    .fun-stats-title {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .fun-stat-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      margin: 0.5rem 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .fun-stat-item:hover {
      transform: translateX(10px);
      background: rgba(255, 255, 255, 0.1);
    }

    .fun-stat-emoji {
      font-size: 2rem;
      margin-right: 1rem;
    }

    .fun-stat-content {
      flex: 1;
    }

    .fun-stat-title {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.2rem;
    }

    .fun-stat-desc {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* ===== POWER RANKINGS ===== */
    .power-ranking {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 2rem 0;
    }

    .power-ranking-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .power-ranking-title {
      font-size: 1.8rem;
      background: var(--fire-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    .power-ranking-subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .power-bar {
      display: flex;
      align-items: center;
      margin: 1rem 0;
      position: relative;
    }

    .power-bar-label {
      width: 150px;
      font-weight: 600;
    }

    .power-bar-track {
      flex: 1;
      height: 30px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .power-bar-fill {
      height: 100%;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 1rem;
      color: white;
      font-weight: bold;
      transition: width 1s ease-out;
      position: relative;
      overflow: hidden;
    }

    .power-bar-fill::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmerBar 2s infinite;
    }

    @keyframes shimmerBar {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .power-bar-change {
      margin-left: 1rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.2rem;
    }

    .power-bar-change.up { color: var(--success); }
    .power-bar-change.down { color: var(--danger); }

    /* ===== CSV IMPORT ===== */
    .import-section {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      margin: 2rem 0;
      border: 2px dashed rgba(102, 126, 234, 0.3);
    }

    .import-section.drag-over {
      background: rgba(102, 126, 234, 0.1);
      border-color: var(--accent);
    }

    .import-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .import-title {
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
    }

    .import-desc {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }

    .import-btn {
      padding: 1rem 2rem;
      background: var(--epic-gradient);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0.5rem;
    }

    .import-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .import-success {
      background: rgba(74, 222, 128, 0.1);
      border-color: var(--success);
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 12px;
    }

    /* ===== ANIMATIONS ===== */
    .animate-in {
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .counter {
      display: inline-block;
      animation: countUp 1s ease-out;
    }

    @keyframes countUp {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }

    /* ===== MOBILE RESPONSIVE ===== */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .nav-tabs {
        padding: 1rem;
        justify-content: flex-start;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .power-bar-label {
        width: 100px;
        font-size: 0.9rem;
      }

      .leaderboard-filters {
        flex-wrap: wrap;
      }

      .achievements-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }

    /* ===== LOADING STATE ===== */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== STATISTICS ENHANCEMENTS ===== */
    .stats-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid rgba(102, 126, 234, 0.2);
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }

    .filter-select:hover,
    .filter-select:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .competitor-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .competitor-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .competitor-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--epic-gradient);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .competitor-card:hover::before {
      transform: scaleX(1);
    }

    .competitor-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      border-color: var(--accent);
    }

    .competitor-card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      transform: translateY(-3px);
    }

    .competitor-card.selected::before {
      transform: scaleX(1);
    }

    .competitor-header {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .competitor-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--epic-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: white;
      margin-right: 1rem;
    }

    .competitor-info h4 {
      font-size: 1.1rem;
      margin-bottom: 0.2rem;
      color: var(--text-primary);
    }

    .competitor-info .status {
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .competitor-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .stat-item {
      text-align: center;
    }

    .stat-item .value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 0.2rem;
    }

    .stat-item .label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .competitor-badges {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .badge {
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge.champion {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #8B4513;
    }

    .badge.podium {
      background: linear-gradient(135deg, #C0C0C0, #808080);
      color: #333;
    }

    .badge.veteran {
      background: rgba(102, 126, 234, 0.2);
      color: var(--accent);
    }

    .badge.rookie {
      background: rgba(67, 233, 123, 0.2);
      color: #43e97b;
    }

    /* Individual Competitor Details */
    .individual-details {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(102, 126, 234, 0.2);
      position: relative;
    }

    .competitor-detail-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    }

    .competitor-detail-header h3 {
      font-size: 1.5rem;
      background: var(--epic-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .close-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      margin-left: auto;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: var(--text-primary);
      transform: scale(1.1);
    }

    .competitor-summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .summary-stat {
      text-align: center;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .summary-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .summary-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .competitor-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .competition-history h4 {
      color: var(--text-primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .competition-list {
      display: grid;
      gap: 0.5rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .competition-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 1rem;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
      border: 1px solid rgba(102, 126, 234, 0.1);
      transition: all 0.3s ease;
    }

    .competition-item:hover {
      background: rgba(102, 126, 234, 0.1);
      transform: translateX(5px);
    }

    .competition-info {
      flex: 1;
    }

    .competition-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.2rem;
    }

    .competition-details {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .competition-position {
      font-size: 1.2rem;
      font-weight: bold;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      min-width: 40px;
      text-align: center;
    }

    .competition-position.first {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #8B4513;
    }

    .competition-position.podium {
      background: linear-gradient(135deg, #C0C0C0, #808080);
      color: #333;
    }

    .competition-position.regular {
      background: rgba(102, 126, 234, 0.2);
      color: var(--accent);
    }

    .overall-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
    }

    /* Mobile responsive for statistics */
    @media (max-width: 768px) {
      .stats-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-select {
        min-width: auto;
        width: 100%;
      }

      .competitor-stats-grid {
        grid-template-columns: 1fr;
      }

      .competitor-summary-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .competitor-charts {
        grid-template-columns: 1fr;
      }

      .overall-charts {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <span class="trophy-logo">üèÜ</span>
        <h1>Pekkas Pokal</h1>
        <span class="year-display" id="year-range">2011-2024</span>
      </div>
      
      <!-- Add Cache Control Button -->
      <div class="header-actions">
        <button id="cache-control-btn" class="icon-btn" title="Cache Control (Ctrl+Shift+C)">üîß</button>
        <button id="load-default-btn" class="icon-btn" title="Ladda Standarddata">üèÜ</button>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="nav-tabs">
    <button class="nav-tab active" data-tab="dashboard"><span>üìä</span> Dashboard</button>
    <button class="nav-tab" data-tab="leaderboard"><span>ü•á</span> Topplista</button>
    <button class="nav-tab" data-tab="achievements"><span>üéñÔ∏è</span> Achievements</button>
    <button class="nav-tab" data-tab="records"><span>üìú</span> Rekord</button>
    <button class="nav-tab" data-tab="statistics"><span>üìà</span> Statistik</button>
    <button class="nav-tab" data-tab="import"><span>üìÅ</span> Importera</button>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <div class="dashboard-grid">
        <div class="stat-card">
          <div class="stat-icon">üèÜ</div>
          <div class="stat-value counter" id="total-competitions">0</div>
          <div class="stat-label">T√§vlingar</div>
          <div class="stat-change" id="comp-change">
            <span>‚Üí</span> Laddar data...
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-value counter" id="total-participants">0</div>
          <div class="stat-label">Deltagare</div>
          <div class="stat-change" id="part-change">
            <span>‚Üí</span> Laddar data...
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üî•</div>
          <div class="stat-value" id="current-champion">‚Äî</div>
          <div class="stat-label">Senaste Vinnare</div>
          <div class="stat-change" id="champ-change">
            <span>üéØ</span> Laddar...
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üëë</div>
          <div class="stat-value" id="most-wins">‚Äî</div>
          <div class="stat-label">Flest Vinster</div>
          <div class="stat-change" id="wins-change">
            <span>üèÖ</span> Laddar...
          </div>
        </div>
      </div>

      <!-- Power Rankings -->
      <div class="power-ranking">
        <div class="power-ranking-header">
          <div class="power-ranking-title">üî• POWER RANKINGS 2024 üî•</div>
          <div class="power-ranking-subtitle">Baserat p√• senaste prestationer och momentum</div>
        </div>
        <div id="power-rankings-list"></div>
      </div>

      <!-- Fun Stats -->
      <div class="fun-stats">
        <div class="fun-stats-title">
          <span>üéâ</span> Roliga Fakta <span>üéâ</span>
        </div>
        <div id="fun-stats-list"></div>
      </div>

      <!-- Recent Activity Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">üìä Deltagande √∂ver Tid</div>
        </div>
        <canvas id="participation-chart"></canvas>
      </div>
    </div>

    <!-- Leaderboard Tab -->
    <div id="leaderboard" class="tab-content">
      <div class="leaderboard">
        <div class="leaderboard-header">
          <div class="leaderboard-title">
            <span>üèÜ</span> Hall of Fame
          </div>
          <div class="leaderboard-filters">
            <button class="filter-btn active" data-filter="all">Alla Tider</button>
            <button class="filter-btn" data-filter="recent">Senaste 5 √Ör</button>
            <button class="filter-btn" data-filter="2024">2024</button>
          </div>
        </div>
        <div class="leaderboard-list" id="leaderboard-list"></div>
      </div>

      <!-- Head to Head Comparison -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">ü•ä Vinstf√∂rdelning</div>
        </div>
        <canvas id="wins-chart"></canvas>
      </div>
    </div>

    <!-- Achievements Tab -->
    <div id="achievements" class="tab-content">
      <h2 style="text-align: center; margin-bottom: 2rem;">üéñÔ∏è Achievements & Utm√§rkelser</h2>
      <div class="achievements-grid" id="achievements-grid"></div>
    </div>

    <!-- Records Tab -->
    <div id="records" class="tab-content">
      <h2 style="text-align: center; margin-bottom: 2rem;">üìú Rekord & Milstolpar</h2>
      <div class="records-grid" id="records-grid"></div>
    </div>

    <!-- Statistics Tab -->
    <div id="statistics" class="tab-content">
      <!-- Statistics Controls -->
      <div class="stats-controls">
        <select id="competitor-filter" class="filter-select">
          <option value="all">Alla Deltagare</option>
        </select>
        <select id="timeframe-filter" class="filter-select">
          <option value="all">Alla √Ör</option>
          <option value="recent">Senaste 5 √Ör</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
        </select>
        <button id="export-stats-btn" class="import-btn" style="margin-left: auto;">
          üìä Exportera Statistik
        </button>
      </div>

      <!-- Competitor Cards Grid -->
      <div class="competitor-stats-grid" id="competitor-stats-grid">
        <!-- Competitor cards will be populated here -->
      </div>

      <!-- Individual Competitor Details -->
      <div id="individual-competitor-details" class="individual-details hidden">
        <div class="competitor-detail-header">
          <h3 id="selected-competitor-name">V√§lj en deltagare</h3>
          <button id="close-individual-view" class="close-btn">‚úï</button>
        </div>
        
        <div class="competitor-detail-content">
          <div class="competitor-summary-stats">
            <div class="summary-stat">
              <div class="summary-value" id="individual-competitions">0</div>
              <div class="summary-label">T√§vlingar</div>
            </div>
            <div class="summary-stat">
              <div class="summary-value" id="individual-wins">0</div>
              <div class="summary-label">Vinster</div>
            </div>
            <div class="summary-stat">
              <div class="summary-value" id="individual-podiums">0</div>
              <div class="summary-label">Pallplatser</div>
            </div>
            <div class="summary-stat">
              <div class="summary-value" id="individual-avg">0.0</div>
              <div class="summary-label">Snittplacering</div>
            </div>
            <div class="summary-stat">
              <div class="summary-value" id="individual-best">-</div>
              <div class="summary-label">B√§sta Placering</div>
            </div>
            <div class="summary-stat">
              <div class="summary-value" id="individual-winrate">0%</div>
              <div class="summary-label">Vinstprocent</div>
            </div>
          </div>

          <div class="competitor-charts">
            <div class="chart-container">
              <div class="chart-header">
                <div class="chart-title">üìà Prestationer √∂ver Tid</div>
              </div>
              <canvas id="individual-performance-chart"></canvas>
            </div>

            <div class="chart-container">
              <div class="chart-header">
                <div class="chart-title">üèÜ Placeringsf√∂rdelning</div>
              </div>
              <canvas id="individual-position-distribution"></canvas>
            </div>
          </div>

          <div class="competition-history">
            <h4>T√§vlingshistorik</h4>
            <div id="individual-competition-list" class="competition-list">
              <!-- Competition history will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Overall Statistics Charts -->
      <div class="overall-charts">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">üìà Prestationsutveckling</div>
          </div>
          <canvas id="performance-chart"></canvas>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">üéØ Genomsnittlig Placering per Deltagare</div>
          </div>
          <canvas id="average-position-chart"></canvas>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">üìä Deltagande √∂ver Tid</div>
          </div>
          <canvas id="participation-stats-chart"></canvas>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">ü•á Vinstf√∂rdelning</div>
          </div>
          <canvas id="wins-distribution-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Import Tab -->
    <div id="import" class="tab-content">
      <div class="import-section" id="import-drop-zone">
        <div class="import-icon">üìÅ</div>
        <div class="import-title">Importera T√§vlingsdata</div>
        <div class="import-desc">Dra och sl√§pp din CSV-fil h√§r eller klicka f√∂r att v√§lja</div>
        <input type="file" id="csv-file" accept=".csv" style="display: none;">
        <button class="import-btn" onclick="document.getElementById('csv-file').click()">
          V√§lj CSV-fil
        </button>
        <button class="import-btn" onclick="loadDefaultDataFromButton()">
          Ladda Standarddata
        </button>
        <div id="import-status"></div>
      </div>
    </div>
  </div>

  <!-- Scripts - Keep your original scripts but add the new ones -->
  
  <!-- Papa Parse for CSV processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
  
  <!-- New Cache Management Script -->
  <script src="cache-manager.js"></script>
  
  <!-- Enhanced CSV Import Script -->
  <script src="csv-import.js"></script>
  
  <!-- Default Data Loader Script -->
  <script src="default-data.js"></script>

  <!-- Your Original Application Script (Modified) -->
  <script>
    // Global competition data
    let competitionData = {
      competitions: [],
      participants: [],
      scores: {},
      initialized: false
    };

    // Initialize application
    function init() {
      setupTabs();
      setupCSVImport();
      setupHeaderButtons();
      
      // Check for saved data
      const savedData = localStorage.getItem('pekkas-pokal-data');
      if (savedData) {
        competitionData = JSON.parse(savedData);
        if (competitionData.initialized) {
          updateAllViews();
        }
      }
    }

    // Setup header buttons
    function setupHeaderButtons() {
      // Cache control button
      document.getElementById('cache-control-btn')?.addEventListener('click', () => {
        if (window.showCacheControl) {
          window.showCacheControl();
        }
      });

      // Load default data button
      document.getElementById('load-default-btn')?.addEventListener('click', loadDefaultDataFromButton);
    }

    // Tab navigation
    function setupTabs() {
      const tabs = document.querySelectorAll('.nav-tab');
      const contents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          
          tabs.forEach(t => t.classList.remove('active'));
          contents.forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(targetTab).classList.add('active');
        });
      });
    }

    // CSV Import with actual parsing
    function setupCSVImport() {
      const dropZone = document.getElementById('import-drop-zone');
      const fileInput = document.getElementById('csv-file');

      // Drag and drop
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        const file = e.dataTransfer.files[0];
        if (file) {
          processCSV(file);
        }
      });

      // File input
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          processCSV(file);
        }
      });
    }

    // Process CSV with enhanced importer
    async function processCSV(file) {
      showImportStatus('Bearbetar CSV-fil...', 'info');
      
      try {
        if (!window.csvImporter) {
          throw new Error('CSV importer inte tillg√§nglig');
        }

        const data = await window.csvImporter.importCSVData(file);
        await window.csvImporter.importIntoApp(data);
        
        competitionData = data;
        updateAllViews();
        
        showImportStatus(
          `‚úÖ Import lyckades! ${data.competitions.length} t√§vlingar och ${data.participants.length} deltagare importerade.`,
          'success'
        );

      } catch (error) {
        console.error('CSV import failed:', error);
        showImportStatus(`‚ùå Import misslyckades: ${error.message}`, 'error');
      }
    }

    // Load default data
    async function loadDefaultDataFromButton() {
      showImportStatus('Laddar standarddata...', 'info');
      
      try {
        if (!window.loadDefaultData) {
          throw new Error('Default data loader inte tillg√§nglig');
        }

        await window.loadDefaultData();
        
        // Reload data
        const savedData = localStorage.getItem('pekkas-pokal-data');
        if (savedData) {
          competitionData = JSON.parse(savedData);
          updateAllViews();
        }
        
        showImportStatus('‚úÖ Standarddata laddad framg√•ngsrikt!', 'success');

      } catch (error) {
        console.error('Default data load failed:', error);
        showImportStatus(`‚ùå Kunde inte ladda standarddata: ${error.message}`, 'error');
      }
    }

    function showImportStatus(message, type) {
      const statusEl = document.getElementById('import-status');
      statusEl.className = type === 'success' ? 'import-success' : 'import-error';
      statusEl.innerHTML = `<div style="margin-top: 1rem; padding: 1rem; border-radius: 8px; background: ${type === 'success' ? 'rgba(74, 222, 128, 0.1)' : 'rgba(248, 113, 113, 0.1)'}; color: ${type === 'success' ? '#4ade80' : '#f87171'}">${message}</div>`;
    }

    function updateAllViews() {
      if (!competitionData.initialized) return;
      
      loadDashboard();
      loadLeaderboard();
      loadAchievements();
      loadRecords();
      loadStatistics();
    }

    // Load Dashboard with real data
    function loadDashboard() {
      // Update stats cards
      document.getElementById('total-competitions').textContent = competitionData.competitions.length;
      document.getElementById('total-participants').textContent = competitionData.participants.length;
      
      // Find latest winner
      const latestComp = competitionData.competitions[competitionData.competitions.length - 1];
      if (latestComp) {
        document.getElementById('current-champion').textContent = latestComp.winner || '‚Äî';
        document.getElementById('champ-change').innerHTML = `<span>üéØ</span> ${latestComp.name} ${latestComp.year}`;
      }
      
      // Calculate most wins
      const winCounts = {};
      competitionData.competitions.forEach(comp => {
        if (comp.winner) {
          winCounts[comp.winner] = (winCounts[comp.winner] || 0) + 1;
        }
      });
      
      const topWinner = Object.entries(winCounts).sort((a, b) => b[1] - a[1])[0];
      if (topWinner) {
        document.getElementById('most-wins').textContent = topWinner[0];
        document.getElementById('wins-change').innerHTML = `<span>üèÖ</span> ${topWinner[1]} vinster totalt`;
      }

      // Update year range
      if (competitionData.competitions.length > 0) {
        const years = competitionData.competitions.map(c => c.year);
        document.getElementById('year-range').textContent = `${Math.min(...years)}-${Math.max(...years)}`;
      }

      // Power Rankings
      calculateAndDisplayPowerRankings();
      
      // Fun Stats
      displayFunStats();
      
      // Participation Chart
      createParticipationChart();
    }

    function calculateAndDisplayPowerRankings() {
      const recentComps = competitionData.competitions.slice(-5);
      const playerScores = {};
      
      competitionData.participants.forEach(p => {
        playerScores[p.name] = { total: 0, count: 0, recent: [] };
      });
      
      recentComps.forEach(comp => {
        Object.entries(comp.scores).forEach(([pId, score]) => {
          const participant = competitionData.participants.find(p => p.id === pId);
          if (participant) {
            playerScores[participant.name].total += (11 - Math.min(score, 10));
            playerScores[participant.name].count++;
            playerScores[participant.name].recent.push(score);
          }
        });
      });
      
      const rankings = Object.entries(playerScores)
        .filter(([_, data]) => data.count > 0)
        .map(([name, data]) => ({
          name,
          power: Math.round((data.total / (data.count * 10)) * 100),
          trend: data.recent.length > 1 && data.recent[data.recent.length-1] < data.recent[0] ? 'up' : 'stable',
          change: Math.abs(data.recent.length > 1 ? data.recent[0] - data.recent[data.recent.length-1] : 0)
        }))
        .sort((a, b) => b.power - a.power)
        .slice(0, 5);
      
      const powerList = document.getElementById('power-rankings-list');
      powerList.innerHTML = '';
      
      const colors = [
        'linear-gradient(135deg, #ff6b6b, #feca57)',
        'linear-gradient(135deg, #48dbfb, #0abde3)',
        'linear-gradient(135deg, #ff9ff3, #ee5a24)',
        'linear-gradient(135deg, #54a0ff, #5f27cd)',
        'linear-gradient(135deg, #00d2d3, #1dd1a1)'
      ];
      
      rankings.forEach((player, index) => {
        const bar = document.createElement('div');
        bar.className = 'power-bar animate-in';
        bar.style.animationDelay = `${index * 0.1}s`;
        
        bar.innerHTML = `
          <div class="power-bar-label">${player.name}</div>
          <div class="power-bar-track">
            <div class="power-bar-fill" style="width: ${player.power}%; background: ${colors[index % colors.length]}">
              ${player.power}%
            </div>
          </div>
          <div class="power-bar-change ${player.trend}">
            ${player.trend === 'up' ? '‚Üë' : '‚Üí'} ${player.change}
          </div>
        `;
        
        powerList.appendChild(bar);
      });
    }

    function displayFunStats() {
      const stats = calculateFunStats();
      const funStatsList = document.getElementById('fun-stats-list');
      funStatsList.innerHTML = '';
      
      stats.forEach((stat, index) => {
        const item = document.createElement('div');
        item.className = 'fun-stat-item animate-in';
        item.style.animationDelay = `${index * 0.1}s`;
        item.innerHTML = `
          <div class="fun-stat-emoji">${stat.emoji}</div>
          <div class="fun-stat-content">
            <div class="fun-stat-title">${stat.title}</div>
            <div class="fun-stat-desc">${stat.desc}</div>
          </div>
        `;
        funStatsList.appendChild(item);
      });
    }

    function calculateFunStats() {
      const stats = [];
      
      // Most consistent (lowest standard deviation)
      const avgPositions = {};
      competitionData.participants.forEach(p => {
        const positions = [];
        competitionData.competitions.forEach(comp => {
          if (comp.scores[p.id]) positions.push(comp.scores[p.id]);
        });
        if (positions.length > 3) {
          const avg = positions.reduce((a, b) => a + b, 0) / positions.length;
          const variance = positions.reduce((sum, pos) => sum + Math.pow(pos - avg, 2), 0) / positions.length;
          avgPositions[p.name] = { avg, stdDev: Math.sqrt(variance), count: positions.length };
        }
      });
      
      const mostConsistent = Object.entries(avgPositions)
        .sort((a, b) => a[1].stdDev - b[1].stdDev)[0];
      
      if (mostConsistent) {
        stats.push({
          emoji: 'üéØ',
          title: 'Mr. Consistent',
          desc: `${mostConsistent[0]} - Mest stabil prestation`
        });
      }
      
      // Comeback kid
      const comebacks = [];
      competitionData.participants.forEach(p => {
        const positions = [];
        competitionData.competitions.forEach(comp => {
          if (comp.scores[p.id]) positions.push({ year: comp.year, pos: comp.scores[p.id] });
        });
        if (positions.length > 4) {
          const firstHalf = positions.slice(0, Math.floor(positions.length/2));
          const secondHalf = positions.slice(Math.floor(positions.length/2));
          const firstAvg = firstHalf.reduce((a, b) => a + b.pos, 0) / firstHalf.length;
          const secondAvg = secondHalf.reduce((a, b) => a + b.pos, 0) / secondHalf.length;
          if (firstAvg > secondAvg && firstAvg - secondAvg > 2) {
            comebacks.push({ name: p.name, improvement: firstAvg - secondAvg });
          }
        }
      });
      
      if (comebacks.length > 0) {
        const best = comebacks.sort((a, b) => b.improvement - a.improvement)[0];
        stats.push({
          emoji: 'üí™',
          title: 'Comeback Kid',
          desc: `${best.name} - Mest f√∂rb√§ttring √∂ver tid`
        });
      }
      
      // Lucky winner (won with minimal margin)
      const closeWins = competitionData.competitions.filter(c => {
        const scores = Object.values(c.scores).sort((a, b) => a - b);
        return scores.length > 1 && scores[0] === 1 && scores[1] === 2;
      });
      
      if (closeWins.length > 0) {
        const luckyWinners = {};
        closeWins.forEach(c => {
          luckyWinners[c.winner] = (luckyWinners[c.winner] || 0) + 1;
        });
        const luckiest = Object.entries(luckyWinners).sort((a, b) => b[1] - a[1])[0];
        if (luckiest) {
          stats.push({
            emoji: 'üçÄ',
            title: 'Lucky Charm',
            desc: `${luckiest[0]} - ${luckiest[1]} knappa vinster`
          });
        }
      }
      
      // Veteran
      const participationCounts = {};
      competitionData.participants.forEach(p => {
        let count = 0;
        competitionData.competitions.forEach(comp => {
          if (comp.scores[p.id] !== undefined) count++;
        });
        participationCounts[p.name] = count;
      });
      
      const veteran = Object.entries(participationCounts).sort((a, b) => b[1] - a[1])[0];
      if (veteran) {
        stats.push({
          emoji: 'üèÖ',
          title: 'J√§rnmannen',
          desc: `${veteran[0]} - ${veteran[1]} t√§vlingar`
        });
      }
      
      // Hot streak
      const recentWinner = competitionData.competitions.slice(-3)
        .map(c => c.winner)
        .filter(w => w);
      
      const streakCounts = {};
      recentWinner.forEach(w => {
        streakCounts[w] = (streakCounts[w] || 0) + 1;
      });
      
      const hotPlayer = Object.entries(streakCounts).sort((a, b) => b[1] - a[1])[0];
      if (hotPlayer && hotPlayer[1] > 1) {
        stats.push({
          emoji: 'üî•',
          title: 'P√• Eld',
          desc: `${hotPlayer[0]} - ${hotPlayer[1]} vinster p√• senaste 3`
        });
      }
      
      return stats;
    }

    // Load Leaderboard
    function loadLeaderboard() {
      const winCounts = {};
      const participations = {};
      const podiums = {};
      
      competitionData.competitions.forEach(comp => {
        if (comp.winner) {
          winCounts[comp.winner] = (winCounts[comp.winner] || 0) + 1;
        }
        
        Object.entries(comp.scores).forEach(([pId, score]) => {
          const participant = competitionData.participants.find(p => p.id === pId);
          if (participant) {
            participations[participant.name] = (participations[participant.name] || 0) + 1;
            if (score <= 3) {
              podiums[participant.name] = (podiums[participant.name] || 0) + 1;
            }
          }
        });
      });

      const leaderboardData = competitionData.participants.map(p => ({
        name: p.name,
        wins: winCounts[p.name] || 0,
        participations: participations[p.name] || 0,
        podiums: podiums[p.name] || 0,
        winRate: participations[p.name] ? ((winCounts[p.name] || 0) / participations[p.name] * 100) : 0
      })).sort((a, b) => b.wins - a.wins || b.winRate - a.winRate);

      const leaderboardList = document.getElementById('leaderboard-list');
      leaderboardList.innerHTML = '';
      
      leaderboardData.slice(0, 10).forEach((player, index) => {
        const item = document.createElement('div');
        const posClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
        item.className = `leaderboard-item ${posClass} animate-in`;
        item.style.animationDelay = `${index * 0.1}s`;
        
        item.innerHTML = `
          <div class="position ${posClass}">${index + 1}</div>
          <div class="player-info">
            <div class="player-name">${player.name}</div>
            <div class="player-stats">
              <span>üèÜ ${player.wins} vinster</span>
              <span>ü•á ${player.podiums} pallplatser</span>
              <span>üìä ${player.winRate.toFixed(1)}% vinstprocent</span>
            </div>
          </div>
          ${index === 0 ? '<div class="trophy-count"><div class="trophy">üëë Champion</div></div>' : ''}
        `;
        
        leaderboardList.appendChild(item);
      });

      // Create wins chart
      createWinsChart(winCounts);
    }

    // Load Achievements
    function loadAchievements() {
      const achievements = calculateAchievements();
      const grid = document.getElementById('achievements-grid');
      grid.innerHTML = '';
      
      achievements.forEach((ach, index) => {
        const card = document.createElement('div');
        card.className = `achievement ${ach.unlocked ? 'unlocked' : 'locked'} ${ach.legendary ? 'legendary' : ''} animate-in`;
        card.style.animationDelay = `${index * 0.05}s`;
        
        card.innerHTML = `
          <div class="achievement-icon">${ach.icon}</div>
          <div class="achievement-name">${ach.name}</div>
          <div class="achievement-desc">${ach.desc}</div>
        `;
        
        grid.appendChild(card);
      });
    }

    function calculateAchievements() {
      const achievements = [];
      const winCounts = {};
      const participations = {};
      
      competitionData.competitions.forEach(comp => {
        if (comp.winner) winCounts[comp.winner] = (winCounts[comp.winner] || 0) + 1;
        Object.entries(comp.scores).forEach(([pId, _]) => {
          const p = competitionData.participants.find(part => part.id === pId);
          if (p) participations[p.name] = (participations[p.name] || 0) + 1;
        });
      });
      
      // Check various achievement conditions
      const hasThreeWins = Object.values(winCounts).some(w => w >= 3);
      const hasFiveWins = Object.values(winCounts).some(w => w >= 5);
      const hasTenParticipations = Object.values(participations).some(p => p >= 10);
      const hasFullParticipation = Object.values(participations).some(p => p === competitionData.competitions.length);
      
      achievements.push(
        { icon: 'üëë', name: 'Kung', desc: 'Vinn 5 t√§vlingar', unlocked: hasFiveWins, legendary: true },
        { icon: 'ü•á', name: 'Guldmedalj√∂r', desc: 'Vinn 3 t√§vlingar', unlocked: hasThreeWins },
        { icon: 'üèÉ', name: 'Maratonl√∂pare', desc: 'Delta i 10 t√§vlingar', unlocked: hasTenParticipations },
        { icon: 'ü¶æ', name: 'J√§rnmannen', desc: 'Delta i alla t√§vlingar', unlocked: hasFullParticipation },
        { icon: 'üåü', name: 'Rising Star', desc: 'F√∂rsta vinsten', unlocked: Object.keys(winCounts).length > 0 },
        { icon: 'üèÅ', name: 'Veteran', desc: '10 √•r i t√§vlingen', unlocked: competitionData.competitions.length >= 10 }
      );
      
      return achievements;
    }

    // Load Records
    function loadRecords() {
      const records = calculateRecords();
      const grid = document.getElementById('records-grid');
      grid.innerHTML = '';
      
      records.forEach((record, index) => {
        const card = document.createElement('div');
        card.className = 'record-card animate-in';
        card.style.animationDelay = `${index * 0.1}s`;
        
        card.innerHTML = `
          <div class="record-label">${record.icon} ${record.label}</div>
          <div class="record-value">${record.value}</div>
          <div class="record-holder">${record.holder}</div>
          <div class="record-date">${record.date}</div>
        `;
        
        grid.appendChild(card);
      });
    }

    function calculateRecords() {
      const records = [];
      const winCounts = {};
      const streaks = {};
      const participations = {};
      const avgPositions = {};
      
      competitionData.competitions.forEach(comp => {
        if (comp.winner) winCounts[comp.winner] = (winCounts[comp.winner] || 0) + 1;
        
        Object.entries(comp.scores).forEach(([pId, score]) => {
          const p = competitionData.participants.find(part => part.id === pId);
          if (p) {
            participations[p.name] = (participations[p.name] || 0) + 1;
            if (!avgPositions[p.name]) avgPositions[p.name] = [];
            avgPositions[p.name].push(score);
          }
        });
      });
      
      // Calculate averages
      Object.entries(avgPositions).forEach(([name, positions]) => {
        avgPositions[name] = positions.reduce((a, b) => a + b, 0) / positions.length;
      });
      
      // Most wins
      const topWinner = Object.entries(winCounts).sort((a, b) => b[1] - a[1])[0];
      if (topWinner) {
        records.push({
          label: 'Flest Vinster',
          value: topWinner[1].toString(),
          holder: topWinner[0],
          date: 'Totalt',
          icon: 'üèÜ'
        });
      }
      
      // Most participations
      const topParticipant = Object.entries(participations).sort((a, b) => b[1] - a[1])[0];
      if (topParticipant) {
        records.push({
          label: 'Flest Deltaganden',
          value: topParticipant[1].toString(),
          holder: topParticipant[0],
          date: 'Totalt',
          icon: 'üìä'
        });
      }
      
      // Best average
      const bestAvg = Object.entries(avgPositions).sort((a, b) => a[1] - b[1])[0];
      if (bestAvg) {
        records.push({
          label: 'B√§sta Snitt',
          value: bestAvg[1].toFixed(2),
          holder: bestAvg[0],
          date: 'Karri√§r',
          icon: 'üìà'
        });
      }
      
      // Years active
      if (competitionData.competitions.length > 0) {
        const years = competitionData.competitions.map(c => c.year);
        records.push({
          label: '√Ör Aktiv',
          value: `${Math.max(...years) - Math.min(...years) + 1} √•r`,
          holder: 'Pekkas Pokal',
          date: `${Math.min(...years)}-${Math.max(...years)}`,
          icon: 'üìÖ'
        });
      }
      
      return records;
    }

    // Load Statistics
    function loadStatistics() {
      populateCompetitorFilter();
      setupStatisticsEventListeners();
      renderCompetitorCards();
      createOverallCharts();
    }

    // Populate competitor filter dropdown
    function populateCompetitorFilter() {
      const competitorFilter = document.getElementById('competitor-filter');
      if (!competitorFilter) return;

      // Clear existing options (except "Alla Deltagare")
      competitorFilter.innerHTML = '<option value="all">Alla Deltagare</option>';

      // Add competitors
      competitionData.participants
        .sort((a, b) => a.name.localeCompare(b.name, 'sv'))
        .forEach(participant => {
          const option = document.createElement('option');
          option.value = participant.id;
          option.textContent = participant.name;
          competitorFilter.appendChild(option);
        });
    }

    // Setup statistics event listeners
    function setupStatisticsEventListeners() {
      const competitorFilter = document.getElementById('competitor-filter');
      const timeframeFilter = document.getElementById('timeframe-filter');
      const exportBtn = document.getElementById('export-stats-btn');
      const closeBtn = document.getElementById('close-individual-view');

      competitorFilter?.addEventListener('change', () => {
        renderCompetitorCards();
        updateIndividualView();
      });

      timeframeFilter?.addEventListener('change', () => {
        renderCompetitorCards();
        updateIndividualView();
        createOverallCharts();
      });

      exportBtn?.addEventListener('click', exportStatistics);
      closeBtn?.addEventListener('click', closeIndividualView);
    }

    // Render competitor cards
    function renderCompetitorCards() {
      const grid = document.getElementById('competitor-stats-grid');
      const competitorFilter = document.getElementById('competitor-filter');
      const timeframeFilter = document.getElementById('timeframe-filter');
      
      if (!grid) return;

      const selectedCompetitor = competitorFilter?.value || 'all';
      const selectedTimeframe = timeframeFilter?.value || 'all';

      // Filter competitions by timeframe
      let filteredCompetitions = competitionData.competitions;
      if (selectedTimeframe !== 'all') {
        const currentYear = new Date().getFullYear();
        if (selectedTimeframe === 'recent') {
          filteredCompetitions = competitionData.competitions.filter(c => c.year >= currentYear - 5);
        } else {
          filteredCompetitions = competitionData.competitions.filter(c => c.year.toString() === selectedTimeframe);
        }
      }

      // Filter participants
      let participants = competitionData.participants;
      if (selectedCompetitor !== 'all') {
        participants = participants.filter(p => p.id === selectedCompetitor);
      }

      grid.innerHTML = '';

      participants.forEach(participant => {
        const stats = calculateCompetitorStats(participant, filteredCompetitions);
        const card = createCompetitorCard(participant, stats);
        grid.appendChild(card);
      });
    }

    // Calculate competitor statistics
    function calculateCompetitorStats(participant, competitions) {
      const participantCompetitions = competitions.filter(comp => 
        comp.scores && comp.scores[participant.id] !== undefined
      );

      const stats = {
        totalCompetitions: participantCompetitions.length,
        wins: 0,
        podiums: 0,
        averagePosition: 0,
        bestPosition: null,
        worstPosition: null,
        winRate: 0,
        positions: [],
        recentForm: []
      };

      if (participantCompetitions.length === 0) return stats;

      let totalPosition = 0;
      participantCompetitions.forEach(comp => {
        const position = comp.scores[participant.id];
        stats.positions.push(position);
        totalPosition += position;

        if (position === 1) stats.wins++;
        if (position <= 3) stats.podiums++;

        if (stats.bestPosition === null || position < stats.bestPosition) {
          stats.bestPosition = position;
        }
        if (stats.worstPosition === null || position > stats.worstPosition) {
          stats.worstPosition = position;
        }
      });

      stats.averagePosition = totalPosition / participantCompetitions.length;
      stats.winRate = (stats.wins / participantCompetitions.length) * 100;

      // Recent form (last 3 competitions)
      stats.recentForm = participantCompetitions
        .sort((a, b) => b.year - a.year)
        .slice(0, 3)
        .map(comp => ({
          competition: comp.name,
          year: comp.year,
          position: comp.scores[participant.id]
        }));

      return stats;
    }

    // Create competitor card
    function createCompetitorCard(participant, stats) {
      const card = document.createElement('div');
      card.className = 'competitor-card';
      card.dataset.participantId = participant.id;

      // Determine badges
      const badges = [];
      if (stats.wins > 0) badges.push({ type: 'champion', text: `${stats.wins} Vinst${stats.wins > 1 ? 'er' : ''}` });
      if (stats.podiums > stats.wins) badges.push({ type: 'podium', text: `${stats.podiums} Pallpl.` });
      if (stats.totalCompetitions >= 10) badges.push({ type: 'veteran', text: 'Veteran' });
      if (stats.totalCompetitions <= 3 && stats.totalCompetitions > 0) badges.push({ type: 'rookie', text: 'Rookie' });

      card.innerHTML = `
        <div class="competitor-header">
          <div class="competitor-avatar">
            ${participant.name.split(' ').map(n => n[0]).join('').substring(0, 2)}
          </div>
          <div class="competitor-info">
            <h4>${participant.name}</h4>
            <div class="status">${participant.status || 'Aktiv'}</div>
          </div>
        </div>
        
        <div class="competitor-stats">
          <div class="stat-item">
            <div class="value">${stats.totalCompetitions}</div>
            <div class="label">T√§vlingar</div>
          </div>
          <div class="stat-item">
            <div class="value">${stats.wins}</div>
            <div class="label">Vinster</div>
          </div>
          <div class="stat-item">
            <div class="value">${stats.podiums}</div>
            <div class="label">Pallplatser</div>
          </div>
          <div class="stat-item">
            <div class="value">${stats.averagePosition.toFixed(1)}</div>
            <div class="label">Snitt</div>
          </div>
        </div>

        <div class="competitor-badges">
          ${badges.map(badge => `<span class="badge ${badge.type}">${badge.text}</span>`).join('')}
        </div>
      `;

      // Add click handler for individual view
      card.addEventListener('click', () => {
        // Remove selected class from all cards
        document.querySelectorAll('.competitor-card').forEach(c => c.classList.remove('selected'));
        // Add selected class to clicked card
        card.classList.add('selected');
        // Show individual details
        showIndividualView(participant, stats);
      });

      return card;
    }

    // Show individual competitor view
    function showIndividualView(participant, stats) {
      const detailsContainer = document.getElementById('individual-competitor-details');
      if (!detailsContainer) return;

      // Update header
      document.getElementById('selected-competitor-name').textContent = participant.name;

      // Update summary stats
      document.getElementById('individual-competitions').textContent = stats.totalCompetitions;
      document.getElementById('individual-wins').textContent = stats.wins;
      document.getElementById('individual-podiums').textContent = stats.podiums;
      document.getElementById('individual-avg').textContent = stats.averagePosition.toFixed(1);
      document.getElementById('individual-best').textContent = stats.bestPosition || '-';
      document.getElementById('individual-winrate').textContent = stats.winRate.toFixed(1) + '%';

      // Show the container
      detailsContainer.classList.remove('hidden');

      // Create individual charts
      createIndividualCharts(participant, stats);
      renderCompetitionHistory(participant);

      // Scroll to the individual view
      detailsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Close individual view
    function closeIndividualView() {
      const detailsContainer = document.getElementById('individual-competitor-details');
      if (detailsContainer) {
        detailsContainer.classList.add('hidden');
      }

      // Remove selected class from all cards
      document.querySelectorAll('.competitor-card').forEach(c => c.classList.remove('selected'));
    }

    // Update individual view when filters change
    function updateIndividualView() {
      const selectedCard = document.querySelector('.competitor-card.selected');
      if (selectedCard) {
        const participantId = selectedCard.dataset.participantId;
        const participant = competitionData.participants.find(p => p.id === participantId);
        if (participant) {
          const timeframeFilter = document.getElementById('timeframe-filter');
          const selectedTimeframe = timeframeFilter?.value || 'all';
          
          let filteredCompetitions = competitionData.competitions;
          if (selectedTimeframe !== 'all') {
            const currentYear = new Date().getFullYear();
            if (selectedTimeframe === 'recent') {
              filteredCompetitions = competitionData.competitions.filter(c => c.year >= currentYear - 5);
            } else {
              filteredCompetitions = competitionData.competitions.filter(c => c.year.toString() === selectedTimeframe);
            }
          }

          const stats = calculateCompetitorStats(participant, filteredCompetitions);
          showIndividualView(participant, stats);
        }
      }
    }

    // Create individual competitor charts
    function createIndividualCharts(participant, stats) {
      createIndividualPerformanceChart(participant);
      createIndividualPositionDistribution(participant, stats);
    }

    // Create individual performance chart
    function createIndividualPerformanceChart(participant) {
      const ctx = document.getElementById('individual-performance-chart');
      if (!ctx) return;

      // Destroy existing chart
      if (window.individualPerformanceChart) {
        window.individualPerformanceChart.destroy();
      }

      const timeframeFilter = document.getElementById('timeframe-filter');
      const selectedTimeframe = timeframeFilter?.value || 'all';
      
      let filteredCompetitions = competitionData.competitions;
      if (selectedTimeframe !== 'all') {
        const currentYear = new Date().getFullYear();
        if (selectedTimeframe === 'recent') {
          filteredCompetitions = competitionData.competitions.filter(c => c.year >= currentYear - 5);
        } else {
          filteredCompetitions = competitionData.competitions.filter(c => c.year.toString() === selectedTimeframe);
        }
      }

      const participantCompetitions = filteredCompetitions
        .filter(comp => comp.scores && comp.scores[participant.id] !== undefined)
        .sort((a, b) => a.year - b.year);

      const data = {
        labels: participantCompetitions.map(comp => `${comp.year} - ${comp.name.substring(0, 15)}${comp.name.length > 15 ? '...' : ''}`),
        datasets: [{
          label: 'Placering',
          data: participantCompetitions.map(comp => comp.scores[participant.id]),
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: participantCompetitions.map(comp => {
            const pos = comp.scores[participant.id];
            return pos === 1 ? '#FFD700' : pos <= 3 ? '#C0C0C0' : '#667eea';
          }),
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 8
        }]
      };

      window.individualPerformanceChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const position = context.parsed.y;
                  const competition = participantCompetitions[context.dataIndex];
                  return [
                    `Placering: ${position}`,
                    `T√§vling: ${competition.name}`,
                    `√Ör: ${competition.year}`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              reverse: true,
              beginAtZero: false,
              title: {
                display: true,
                text: 'Placering (L√§gre = B√§ttre)',
                color: '#a8b2d1'
              },
              ticks: {
                stepSize: 1,
                color: '#a8b2d1'
              },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            x: {
              title: {
                display: true,
                text: 'T√§vlingar',
                color: '#a8b2d1'
              },
              ticks: {
                maxRotation: 45,
                color: '#a8b2d1'
              },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
          }
        }
      });
    }

    // Create individual position distribution chart
    function createIndividualPositionDistribution(participant, stats) {
      const ctx = document.getElementById('individual-position-distribution');
      if (!ctx) return;

      // Destroy existing chart
      if (window.individualPositionChart) {
        window.individualPositionChart.destroy();
      }

      // Group positions into ranges
      const positionGroups = {
        '1:a plats': 0,
        '2-3 plats': 0,
        '4-5 plats': 0,
        '6-10 plats': 0,
        '11+ plats': 0
      };

      stats.positions.forEach(pos => {
        if (pos === 1) positionGroups['1:a plats']++;
        else if (pos <= 3) positionGroups['2-3 plats']++;
        else if (pos <= 5) positionGroups['4-5 plats']++;
        else if (pos <= 10) positionGroups['6-10 plats']++;
        else positionGroups['11+ plats']++;
      });

      const data = {
        labels: Object.keys(positionGroups),
        datasets: [{
          data: Object.values(positionGroups),
          backgroundColor: [
            '#FFD700', // Gold
            '#C0C0C0', // Silver
            '#CD7F32', // Bronze
            '#667eea', // Blue
            '#f87171'  // Red
          ],
          borderColor: '#ffffff',
          borderWidth: 2
        }]
      };

      window.individualPositionChart = new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { 
                color: '#a8b2d1',
                padding: 15,
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                  return `${context.label}: ${context.parsed} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Render competition history
    function renderCompetitionHistory(participant) {
      const listContainer = document.getElementById('individual-competition-list');
      if (!listContainer) return;

      const timeframeFilter = document.getElementById('timeframe-filter');
      const selectedTimeframe = timeframeFilter?.value || 'all';
      
      let filteredCompetitions = competitionData.competitions;
      if (selectedTimeframe !== 'all') {
        const currentYear = new Date().getFullYear();
        if (selectedTimeframe === 'recent') {
          filteredCompetitions = competitionData.competitions.filter(c => c.year >= currentYear - 5);
        } else {
          filteredCompetitions = competitionData.competitions.filter(c => c.year.toString() === selectedTimeframe);
        }
      }

      const participantCompetitions = filteredCompetitions
        .filter(comp => comp.scores && comp.scores[participant.id] !== undefined)
        .sort((a, b) => b.year - a.year); // Most recent first

      listContainer.innerHTML = '';

      participantCompetitions.forEach(comp => {
        const position = comp.scores[participant.id];
        const item = document.createElement('div');
        item.className = 'competition-item';

        const positionClass = position === 1 ? 'first' : position <= 3 ? 'podium' : 'regular';

        item.innerHTML = `
          <div class="competition-info">
            <div class="competition-name">${comp.name}</div>
            <div class="competition-details">${comp.year} ‚Ä¢ ${comp.location || 'Ok√§nd plats'}</div>
          </div>
          <div class="competition-position ${positionClass}">
            ${position}
          </div>
        `;

        listContainer.appendChild(item);
      });

      if (participantCompetitions.length === 0) {
        listContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">Inga t√§vlingar funna f√∂r vald tidsperiod</p>';
      }
    }

    // Create overall charts
    function createOverallCharts() {
      createPerformanceChart();
      createAveragePositionChart();
      createParticipationStatsChart();
      createWinsDistributionChart();
    }

    // Create participation stats chart
    function createParticipationStatsChart() {
      const ctx = document.getElementById('participation-stats-chart');
      if (!ctx) return;

      // Destroy existing chart
      if (window.participationStatsChart) {
        window.participationStatsChart.destroy();
      }

      const timeframeFilter = document.getElementById('timeframe-filter');
      const selectedTimeframe = timeframeFilter?.value || 'all';
      
      let filteredCompetitions = competitionData.competitions;
      if (selectedTimeframe !== 'all') {
        const currentYear = new Date().getFullYear();
        if (selectedTimeframe === 'recent') {
          filteredCompetitions = competitionData.competitions.filter(c => c.year >= currentYear - 5);
        } else {
          filteredCompetitions = competitionData.competitions.filter(c => c.year.toString() === selectedTimeframe);
        }
      }

      const years = filteredCompetitions.map(c => c.year);
      const participantCounts = filteredCompetitions.map(c => Object.keys(c.scores || {}).length);

      const data = {
        labels: years,
        datasets: [{
          label: 'Antal Deltagare',
          data: participantCounts,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#667eea',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 8
        }]
      };

      window.participationStatsChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Antal Deltagare',
                color: '#a8b2d1'
              },
              ticks: { color: '#a8b2d1' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            x: {
              title: {
                display: true,
                text: '√Ör',
                color: '#a8b2d1'
              },
              ticks: { color: '#a8b2d1' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
          }
        }
      });
    }

    // Create wins distribution chart
    function createWinsDistributionChart() {
      const ctx = document.getElementById('wins-distribution-chart');
      if (!ctx) return;

      // Destroy existing chart
      if (window.winsDistributionChart) {
        window.winsDistributionChart.destroy();
      }

      const timeframeFilter = document.getElementById('timeframe-filter');
      const selectedTimeframe = timeframeFilter?.value || 'all';
      
      let filteredCompetitions = competitionData.competitions;
      if (selectedTimeframe !== 'all') {
        const currentYear = new Date().getFullYear();
        if (selectedTimeframe === 'recent') {
          filteredCompetitions = competitionData.competitions.filter(c => c.year >= currentYear - 5);
        } else {
          filteredCompetitions = competitionData.competitions.filter(c => c.year.toString() === selectedTimeframe);
        }
      }

      const winCounts = {};
      filteredCompetitions.forEach(comp => {
        if (comp.winner) {
          winCounts[comp.winner] = (winCounts[comp.winner] || 0) + 1;
        }
      });

      const sortedWins = Object.entries(winCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8); // Top 8 winners

      const data = {
        labels: sortedWins.map(([name]) => name),
        datasets: [{
          data: sortedWins.map(([, wins]) => wins),
          backgroundColor: [
            '#FFD700', '#C0C0C0', '#CD7F32', '#667eea', '#764ba2',
            '#f093fb', '#f5576c', '#4facfe'
          ],
          borderColor: '#ffffff',
          borderWidth: 2
        }]
      };

      window.winsDistributionChart = new Chart(ctx.getContext('2d'), {
        type: 'pie',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { 
                color: '#a8b2d1',
                padding: 15,
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                  return `${context.label}: ${context.parsed} vinster (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Export statistics
    function exportStatistics() {
      const timeframeFilter = document.getElementById('timeframe-filter');
      const selectedTimeframe = timeframeFilter?.value || 'all';
      
      let filteredCompetitions = competitionData.competitions;
      if (selectedTimeframe !== 'all') {
        const currentYear = new Date().getFullYear();
        if (selectedTimeframe === 'recent') {
          filteredCompetitions = competitionData.competitions.filter(c => c.year >= currentYear - 5);
        } else {
          filteredCompetitions = competitionData.competitions.filter(c => c.year.toString() === selectedTimeframe);
        }
      }

      const statsData = competitionData.participants.map(participant => {
        const stats = calculateCompetitorStats(participant, filteredCompetitions);
        return {
          'Namn': participant.name,
          'T√§vlingar': stats.totalCompetitions,
          'Vinster': stats.wins,
          'Pallplatser': stats.podiums,
          'Genomsnittlig Placering': stats.averagePosition.toFixed(2),
          'B√§sta Placering': stats.bestPosition || 'N/A',
          'S√§msta Placering': stats.worstPosition || 'N/A',
          'Vinstprocent': stats.winRate.toFixed(1) + '%'
        };
      });

      // Convert to CSV
      const headers = Object.keys(statsData[0]);
      const csvContent = [
        headers.join(','),
        ...statsData.map(row => headers.map(header => `"${row[header]}"`).join(','))
      ].join('\n');

      // Download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `pekkas-pokal-statistik-${selectedTimeframe}-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);

      showImportStatus('üìä Statistik exporterad som CSV-fil!', 'success');
    }

    // Chart Creation Functions
    function createParticipationChart() {
      const ctx = document.getElementById('participation-chart');
      if (!ctx) return;
      
      const years = competitionData.competitions.map(c => c.year);
      const participantCounts = competitionData.competitions.map(c => Object.keys(c.scores).length);
      
      new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: years,
          datasets: [{
            label: 'Antal Deltagare',
            data: participantCounts,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#a8b2d1' }
            },
            x: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#a8b2d1' }
            }
          }
        }
      });
    }

    function createWinsChart(winCounts) {
      const ctx = document.getElementById('wins-chart');
      if (!ctx) return;
      
      const labels = Object.keys(winCounts);
      const data = Object.values(winCounts);
      
      new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#FFD700', '#C0C0C0', '#CD7F32', '#667eea', '#764ba2',
              '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#a8b2d1' }
            }
          }
        }
      });
    }

    function createPerformanceChart() {
      const ctx = document.getElementById('performance-chart');
      if (!ctx) return;
      
      // Get top 3 performers
      const playerData = {};
      competitionData.competitions.slice(-6).forEach(comp => {
        Object.entries(comp.scores).forEach(([pId, score]) => {
          const p = competitionData.participants.find(part => part.id === pId);
          if (p) {
            if (!playerData[p.name]) playerData[p.name] = [];
            playerData[p.name].push({ year: comp.year, score });
          }
        });
      });
      
      const datasets = Object.entries(playerData)
        .slice(0, 3)
        .map((player, idx) => ({
          label: player[0],
          data: player[1].map(d => d.score),
          borderColor: ['#ff6b6b', '#4facfe', '#43e97b'][idx],
          backgroundColor: ['rgba(255, 107, 107, 0.1)', 'rgba(79, 172, 254, 0.1)', 'rgba(67, 233, 123, 0.1)'][idx],
          tension: 0.4
        }));
      
      new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: competitionData.competitions.slice(-6).map(c => c.year),
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#a8b2d1' }
            }
          },
          scales: {
            y: {
              reverse: true,
              min: 1,
              max: 10,
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#a8b2d1' }
            },
            x: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#a8b2d1' }
            }
          }
        }
      });
    }

    function createAveragePositionChart() {
      const ctx = document.getElementById('average-position-chart');
      if (!ctx) return;
      
      const avgPositions = {};
      competitionData.participants.forEach(p => {
        const positions = [];
        competitionData.competitions.forEach(comp => {
          if (comp.scores[p.id]) positions.push(comp.scores[p.id]);
        });
        if (positions.length > 0) {
          avgPositions[p.name] = positions.reduce((a, b) => a + b, 0) / positions.length;
        }
      });
      
      const sorted = Object.entries(avgPositions)
        .sort((a, b) => a[1] - b[1])
        .slice(0, 5);
      
      new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: sorted.map(s => s[0]),
          datasets: [{
            label: 'Genomsnittlig Placering',
            data: sorted.map(s => s[1]),
            backgroundColor: [
              'rgba(255, 215, 0, 0.8)',
              'rgba(192, 192, 192, 0.8)',
              'rgba(205, 127, 50, 0.8)',
              'rgba(102, 126, 234, 0.8)',
              'rgba(118, 75, 162, 0.8)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              reverse: true,
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#a8b2d1' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#a8b2d1' }
            }
          }
        }
      });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>